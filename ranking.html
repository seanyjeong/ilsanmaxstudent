<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë­í‚¹</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #28a745;
            --danger: #f72585;
            --warning: #f8961e;
            --dark: #1e1e2e;
            --light: #f8f9fa;
            --gray: #adb5bd;
            --gray-light: #e9ecef;
            --border-radius: 16px;
            --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: var(--dark);
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* í—¤ë” */
        .page-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--border-radius);
            color: white;
            box-shadow: var(--card-shadow);
        }

        .page-header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
        }

        .page-header p {
            margin: 8px 0 0 0;
            opacity: 0.9;
        }

        /* ë‚´ ìˆœìœ„ ì¹´ë“œ */
        .my-rank-card {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border: 3px solid #ff6b6b;
        }

        .my-rank-card h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #ff6b6b;
        }

        .my-rank-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .my-rank-item {
            text-align: center;
            background: white;
            padding: 15px;
            border-radius: 12px;
        }

        .my-rank-item .label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 5px;
        }

        .my-rank-item .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        /* íƒ­ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            background: white;
            color: var(--gray);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        /* ë­í‚¹ ì¹´ë“œ */
        .ranking-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .ranking-card h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ë­í‚¹ ì•„ì´í…œ */
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 12px;
            background: var(--light);
            transition: var(--transition);
        }

        .ranking-item:hover {
            transform: translateX(5px);
            background: var(--gray-light);
        }

        .ranking-item.me {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: 2px solid var(--primary);
        }

        .ranking-item.top1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: 2px solid #ff6b6b;
        }

        .ranking-item.top2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            border: 2px solid #999;
        }

        .ranking-item.top3 {
            background: linear-gradient(135deg, #cd7f32, #e8a87c);
            border: 2px solid #8b4513;
        }

        .rank-badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .rank-badge.top1 {
            background: linear-gradient(135deg, #ffd700, #ff6b6b);
            color: white;
            font-size: 24px;
        }

        .rank-badge.top2 {
            background: linear-gradient(135deg, #c0c0c0, #999);
            color: white;
            font-size: 22px;
        }

        .rank-badge.top3 {
            background: linear-gradient(135deg, #cd7f32, #8b4513);
            color: white;
            font-size: 20px;
        }

        .rank-badge.other {
            background: var(--gray-light);
            color: var(--dark);
            font-size: 16px;
        }

        .student-info {
            flex-grow: 1;
        }

        .student-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .student-meta {
            font-size: 12px;
            color: var(--gray);
        }

        .level-info {
            text-align: right;
            flex-shrink: 0;
        }

        .level-badge {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .exp-text {
            font-size: 11px;
            color: var(--gray);
        }

        /* ë¡œë”© */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .loading i {
            font-size: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* ë¹ˆ ìƒíƒœ */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="page-header">
            <h1>ğŸ† ë ˆë²¨ ë­í‚¹</h1>
            <p>ê²½ìŸì—ì„œ ì™•ì¢Œë¥¼ ì°¨ì§€í•´ë¼</p>
        </div>

        <!-- ë‚´ ìˆœìœ„ -->
        <div class="my-rank-card" id="myRankCard" style="display: none;">
            <h3>ğŸ’ª ë‚´ ìˆœìœ„</h3>
            <div class="my-rank-grid">
                <div class="my-rank-item">
                    <div class="label">ì „ì²´ ìˆœìœ„</div>
                    <div class="value" id="myTotalRank">-</div>
                </div>
                <div class="my-rank-item">
                    <div class="label"><span id="myBranchName">-</span> ìˆœìœ„</div>
                    <div class="value" id="myBranchRank">-</div>
                </div>
            </div>
        </div>

        <!-- íƒ­ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('all')">
                <i class="fas fa-globe"></i> ì „ì²´ ë­í‚¹
            </button>
            <button class="tab-btn" onclick="switchTab('branch')">
                <i class="fas fa-building"></i> ìš°ë¦¬ ì§€ì 
            </button>
        </div>

        <!-- ë­í‚¹ ë¦¬ìŠ¤íŠ¸ -->
        <div class="ranking-card">
            <h3>
                <i class="fas fa-trophy"></i>
                <span id="rankingTitle">ì „ì²´ ë­í‚¹</span>
            </h3>
            <div id="rankingLoading" class="loading">
                <i class="fas fa-spinner"></i>
                <p>ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <div id="rankingList" class="ranking-list" style="display: none;"></div>
            <div id="rankingEmpty" class="empty-state" style="display: none;">
                <i class="fas fa-inbox"></i>
                <p>ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('jwt_token');
        let currentTab = 'all';
        let myAccountId = null;
        let myBranch = null;

        // JWT íŒŒì‹±
        if (token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
                    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                ).join(''));
                const payload = JSON.parse(jsonPayload);
                myAccountId = payload.account_id;
                myBranch = payload.branch;
            } catch (err) {
                console.error('í† í° íŒŒì‹± ì˜¤ë¥˜:', err);
            }
        }

        // ë‚´ ë­í‚¹ ë¡œë“œ
        async function loadMyRank() {
            try {
                const response = await fetch('https://supermax.kr/jungsi/ranking/my', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    console.warn('ë‚´ ë­í‚¹ ì¡°íšŒ ì‹¤íŒ¨');
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    document.getElementById('myTotalRank').textContent = data.totalRank + 'ìœ„';
                    document.getElementById('myBranchRank').textContent = data.branchRank + 'ìœ„';
                    document.getElementById('myBranchName').textContent = data.myInfo.branch;
                    document.getElementById('myRankCard').style.display = 'block';
                }
            } catch (error) {
                console.error('ë‚´ ë­í‚¹ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // íƒ­ ì „í™˜
        function switchTab(tab) {
            currentTab = tab;

            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach((btn, index) => {
                if ((tab === 'all' && index === 0) || (tab === 'branch' && index === 1)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // íƒ€ì´í‹€ ë³€ê²½
            if (tab === 'all') {
                document.getElementById('rankingTitle').textContent = 'ì „ì²´ ë­í‚¹';
            } else {
                document.getElementById('rankingTitle').textContent = `${myBranch} ì§€ì  ë­í‚¹`;
            }

            // ë­í‚¹ ë¡œë“œ
            loadRanking(tab);
        }

        // ë­í‚¹ ë¡œë“œ
        async function loadRanking(tab) {
            const loadingEl = document.getElementById('rankingLoading');
            const listEl = document.getElementById('rankingList');
            const emptyEl = document.getElementById('rankingEmpty');

            loadingEl.style.display = 'block';
            listEl.style.display = 'none';
            emptyEl.style.display = 'none';

            try {
                let url = 'https://supermax.kr/jungsi/ranking/all';
                if (tab === 'branch') {
                    url = `https://supermax.kr/jungsi/ranking/branch?branch=${encodeURIComponent(myBranch)}`;
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error('ë­í‚¹ ì¡°íšŒ ì‹¤íŒ¨');
                }

                const data = await response.json();
                if (data.success && data.rankings.length > 0) {
                    displayRankings(data.rankings);
                    listEl.style.display = 'flex';
                } else {
                    emptyEl.style.display = 'block';
                }
            } catch (error) {
                console.error('ë­í‚¹ ë¡œë“œ ì˜¤ë¥˜:', error);
                emptyEl.style.display = 'block';
            } finally {
                loadingEl.style.display = 'none';
            }
        }

        // ë­í‚¹ í‘œì‹œ
        function displayRankings(rankings) {
            const listEl = document.getElementById('rankingList');
            let html = '';

            rankings.forEach(student => {
                const isMe = student.student_account_id === myAccountId;
                const rank = student.rank;

                let rankClass = 'other';
                let itemClass = '';
                let rankIcon = rank;

                if (rank === 1) {
                    rankClass = 'top1';
                    itemClass = 'top1';
                    rankIcon = 'ğŸ¥‡';
                } else if (rank === 2) {
                    rankClass = 'top2';
                    itemClass = 'top2';
                    rankIcon = 'ğŸ¥ˆ';
                } else if (rank === 3) {
                    rankClass = 'top3';
                    itemClass = 'top3';
                    rankIcon = 'ğŸ¥‰';
                }

                if (isMe) {
                    itemClass += ' me';
                }

                html += `
                    <div class="ranking-item ${itemClass}">
                        <div class="rank-badge ${rankClass}">
                            ${rankIcon}
                        </div>
                        <div class="student-info">
                            <div class="student-name">
                                ${student.name}
                                ${isMe ? '<span style="color: var(--primary); font-size: 12px;">ğŸ‘ˆ ë‚˜</span>' : ''}
                            </div>
                            <div class="student-meta">
                                ${student.branch} | ${student.grade}í•™ë…„
                            </div>
                        </div>
                        <div class="level-info">
                            <div class="level-badge">Lv.${student.current_level}</div>
                            <div class="exp-text">${student.current_exp} EXP</div>
                        </div>
                    </div>
                `;
            });

            listEl.innerHTML = html;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', () => {
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = 'student_login.html';
                return;
            }

            loadMyRank();
            loadRanking('all');
        });
    </script>
</body>
</html>
