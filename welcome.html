<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í™ˆ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #28a745;
            --danger: #f72585;
            --warning: #f8961e;
            --dark: #1e1e2e;
            --light: #f8f9fa;
            --gray: #adb5bd;
            --gray-light: #e9ecef;
            --border-radius: 16px;
            --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
            --text-secondary: #6c757d; 
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: var(--dark);
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
        }

        .card {
            background-color: #ffffff;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
        }

        /* 1. í—¤ë” */
        .welcome-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: var(--border-radius);
            padding: 20px;
            color: white;
            box-shadow: var(--card-shadow);
        }

        /* 2. ì§€ì  ë¡œê³  */
        #branchLogo {
            width: 100px;
            height: 100px;
            background-color: rgb(255, 255, 255);
            border-radius: 50%;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
            object-fit: fill;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        #branchLogoTextDiv {
             width: 60px;
             height: 60px;
             background-color: rgba(255, 255, 255, 0.2);
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             font-size: 14px;
             font-weight: bold;
             color: white;
             text-align: center;
             flex-shrink: 0;
             border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .welcome-text {
            flex-grow: 1;
            padding-left: 15px;
        }

        .welcome-text h2 {
            font-size: 22px;
            font-weight: 700;
            margin: 0 0 5px 0;
            color: white;
        }

        .welcome-text p {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
        }

        .card h3 {
            font-size: 18px;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
        }

        .card h3 i {
            margin-right: 8px;
            color: var(--primary);
        }

        /* --- ì˜¤ëŠ˜ì˜ í•„ìˆ˜ ìš´ë™ ë¦¬ìŠ¤íŠ¸ --- */
        .assignment-list {
            list-style: none; padding-left: 0; margin: 0;
        }
        .assignment-item {
            display: flex; align-items: flex-start;
            padding: 12px 5px; border-bottom: 1px solid var(--gray-light);
            transition: background-color 0.2s;
        }
        .assignment-item:last-child { border-bottom: none; }
        .assignment-item input[type="checkbox"] {
            width: 20px; height: 20px; margin-right: 15px; flex-shrink: 0;
            cursor: pointer; accent-color: var(--success);
            margin-top: 2px;
        }
        .assignment-details { flex-grow: 1; font-size: 15px; }
        .assignment-details .exercise-name { font-weight: 600; display: block; margin-bottom: 3px; }
        .assignment-details .target-info { font-size: 0.9em; color: var(--text-secondary); display: block; margin-bottom: 4px; }
        .assignment-details .teacher-name { font-size: 0.8em; color: var(--gray); font-style: italic; }

        /* ì™„ë£Œëœ í•­ëª© ìŠ¤íƒ€ì¼ */
        .assignment-item.completed { background-color: #f0fff4; }
        .assignment-item.completed .assignment-details { text-decoration: line-through; color: var(--gray); }
        .assignment-item.completed .exercise-name { color: var(--success); text-decoration: none; }
        .assignment-item.completed .target-info { text-decoration: none; }
        .assignment-item.completed .teacher-name { text-decoration: none; }

        .loading, .no-data { text-align: center; padding: 15px; color: var(--text-secondary); font-size: 14px;}

        /* í•™ì› ê³µì§€ (ë²„íŠ¼ ì—­í• ) */
        .notice-list button.notice-link {
            display: block; 
            width: 100%;
            padding: 10px 5px;
            text-decoration: none;
            color: var(--dark);
            border: none;
            background: none;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
            transition: var(--transition);
            cursor: pointer;
            border-left: 4px solid transparent; /* â­ï¸ ë°˜ì§ì„ íš¨ê³¼ë¥¼ ìœ„í•œ ê³µê°„ í™•ë³´ */
        }
        .notice-list button.notice-link:last-child { border-bottom: none; }
        
        /* â­ï¸ [ìˆ˜ì •] :not(.notice-newest) ì¶”ê°€ (hover ì¶©ëŒ ë°©ì§€) */
        .notice-list button.notice-link:not(.notice-newest):hover { 
            background-color: rgba(67, 97, 238, 0.05); 
            border-radius: 8px; 
            padding-left: 10px; 
            border-left-color: var(--primary-light);
        }
        
        .notice-title {
            font-size: 15px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            display: block;
            margin-bottom: 3px;
            pointer-events: none;
        }
        .notice-author {
            font-size: 0.8em;
            color: var(--gray);
            font-style: italic;
            display: block;
            pointer-events: none;
        }

        /* â­ï¸ [ì‹ ê·œ] 'ë°˜ì§ì´ëŠ”' ìµœì‹  ê³µì§€ CSS */
        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); /* --primary color, 40% opacity */
            }
            70% {
                box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); /* Glow effect */
            }
            100% {
                box-shadow: 0 0 0 0 rgba(67, 97, 238, 0);
            }
        }

        .notice-list button.notice-link.notice-newest {
            background-color: #f8faff; /* ì˜…ì€ íŒŒë€ìƒ‰ ë°°ê²½ìœ¼ë¡œ ê°•ì¡° */
            border-left: 4px solid var(--primary); /* ì™¼ìª½ì— ê°•ì¡°ì„  */
            padding-left: 10px; /* ì•ˆìª½ ì—¬ë°± */
            
            /* â­ï¸ ë°˜ì§ì´ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì ìš© */
            animation: pulse-glow 2s infinite;
        }
        /* â­ï¸ [ì‹ ê·œ] CSS ë */


        /* ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ */
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }
        .action-btn {
            background: white; border: none; border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); transition: var(--transition);
            cursor: pointer; text-decoration: none; color: var(--dark);
        }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1); }
        .action-btn i { font-size: 24px; margin-bottom: 8px; color: var(--primary); }
        .action-btn span { font-size: 13px; font-weight: 600; }

        /* --- Toast Popup --- */
        .toast-popup {
            position: fixed; bottom: 85px;
            left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.85); color: white; padding: 12px 20px; border-radius: 25px;
            font-size: 14px; z-index: 1001; opacity: 0;
            transition: opacity 0.4s ease, bottom 0.4s ease; white-space: nowrap;
        }
        .toast-popup.show { opacity: 1; bottom: 105px; }
        .toast-popup.success { background-color: rgba(40, 167, 69, 0.9); }
        .toast-popup.error { background-color: rgba(220, 38, 38, 0.9); }

        /* --- ëª¨ë‹¬ ìŠ¤íƒ€ì¼ --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 1000;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease; padding: 15px;
        }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content {
            background-color: #fff; border-radius: var(--border-radius);
            width: 100%; max-width: 500px; max-height: 85vh;
            display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-header {
            padding: 15px 20px; border-bottom: 1px solid var(--gray-light);
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .modal-header h3 { margin: 0; font-size: 1.1rem; color: var(--primary); font-weight: 700; }
        .modal-header .close-btn { background: none; border: none; font-size: 24px; color: var(--gray); cursor: pointer; padding: 0 5px; }
        .modal-body {
            padding: 20px; overflow-y: auto;
            line-height: 1.6;
        }
        .notice-meta {
            font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;
        }
        .notice-content-area {
             white-space: pre-wrap;
             word-break: break-word;
             font-size: 0.95rem;
        }
        hr { border: none; border-top: 1px solid var(--gray-light); margin: 15px 0; }

        
        /* â­ï¸ [ìˆ˜ì •] í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì• ë‹ˆë©”ì´ì…˜ CSS (í­ì£½ ë²„ì „) â­ï¸ */
        .quest-complete-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3); /* ë°˜íˆ¬ëª… ë°°ê²½ */
            z-index: 2000; /* ë©”ë‰´ ë°”ë³´ë‹¤ ìœ„ì— */
            display: flex;
            justify-content: center;
            align-items: center;
            
            /* ì´ˆê¸° ìƒíƒœ: ìˆ¨ê¹€ */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0s 0.5s;
            backdrop-filter: blur(5px);
            cursor: pointer; /* â­ï¸ í´ë¦­í•´ì„œ ë‹«ê¸° */
        }

        .quest-complete-overlay.show {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease;
        }

        /* ì™„ë£Œ ë©”ì‹œì§€ ì¹´ë“œ */
        .quest-complete-message {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px 40px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            
            /* ì´ˆê¸° ìƒíƒœ: ì•„ë˜ì—ì„œ ìœ„ë¡œ */
            transform: translateY(50px);
            opacity: 0;
            transition: transform 0.5s ease-out 0.2s, opacity 0.5s ease-out 0.2s;
            cursor: default; /* â­ï¸ ë©”ì‹œì§€ í´ë¦­ ì‹œ ë‹«ê¸° ë°©ì§€ */
        }

        .quest-complete-overlay.show .quest-complete-message {
            transform: translateY(0);
            opacity: 1;
        }

        .quest-complete-message h2 {
            font-size: 24px;
            margin: 10px 0 5px 0;
        }
        .quest-complete-message p {
            font-size: 14px;
            margin: 0;
            opacity: 0.9;
        }
        .quest-complete-message i {
            font-size: 30px;
            color: var(--warning);
        }

        /* ë ˆë²¨ì—… ì¶•í•˜ ëª¨ë‹¬ */
        .levelup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .levelup-overlay.show {
            display: flex;
        }

        .levelup-modal {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffd93d 50%, #ff6b6b 100%);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            color: white;
            max-width: 400px;
            position: relative;
            animation: bounceIn 0.6s ease, pulseGlow 1.5s ease-in-out infinite;
            box-shadow: 0 20px 60px rgba(255, 107, 107, 0.5), 0 0 100px rgba(255, 217, 61, 0.4);
            border: 3px solid #ffd700;
        }

        .levelup-icon {
            font-size: 100px;
            margin-bottom: 20px;
            animation: punchEffect 0.8s ease infinite;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
        }

        .levelup-title {
            font-size: 42px;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 3px 3px 0px #000,
                         -1px -1px 0px #ffd700,
                         1px -1px 0px #ffd700,
                         -1px 1px 0px #ffd700,
                         1px 1px 0px #ffd700;
            letter-spacing: 3px;
            animation: textShake 0.5s ease infinite;
        }

        .levelup-subtitle {
            font-size: 18px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .levelup-levels {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            font-size: 48px;
            font-weight: 700;
        }

        .levelup-arrow {
            font-size: 32px;
            opacity: 0.7;
        }

        .levelup-exp {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 15px;
        }

        .levelup-close-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .levelup-close-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
        }

        /* íŒŒí‹°í´ íš¨ê³¼ */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #ffd700;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0.3);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes rotateScale {
            0%, 100% {
                transform: rotate(0deg) scale(1);
            }
            25% {
                transform: rotate(-10deg) scale(1.1);
            }
            75% {
                transform: rotate(10deg) scale(1.1);
            }
        }

        @keyframes punchEffect {
            0%, 100% {
                transform: scale(1) rotate(0deg);
            }
            25% {
                transform: scale(1.2) rotate(-5deg);
            }
            50% {
                transform: scale(1.3) rotate(5deg);
            }
            75% {
                transform: scale(1.2) rotate(-5deg);
            }
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 20px 60px rgba(255, 107, 107, 0.5), 0 0 100px rgba(255, 217, 61, 0.4);
            }
            50% {
                box-shadow: 0 20px 60px rgba(255, 107, 107, 0.8), 0 0 150px rgba(255, 217, 61, 0.7);
            }
        }

        @keyframes textShake {
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-2px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(2px);
            }
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="welcome-header">
            <img id="branchLogo" src="https://github.com/seanyjeong/ilsanmaxstudent/blob/main/ilsanmax.png?raw=true" alt="ì§€ì  ë¡œê³ ">
            <div class="welcome-text">
                <h2><span id="studentName">í•™ìƒ</span>ë‹˜, ì˜¤ëŠ˜ë„ ë°˜ê°‘ìŠµë‹ˆë‹¤.</h2>
                <p>JUST ILSAN-MAX</p>

                <!-- ë ˆë²¨ í‘œì‹œ -->
                <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                    <div style="font-size: 16px; font-weight: 700; color: rgba(255,255,255,0.95);">
                        Lv. <span id="studentLevel">1</span>
                    </div>
                    <div style="flex-grow: 1;">
                        <div style="width: 100%; height: 8px; background-color: rgba(255,255,255,0.3); border-radius: 4px; overflow: hidden;">
                            <div id="studentExpBar" style="height: 100%; background: linear-gradient(90deg, #ffd700, #ffed4e); width: 0%; transition: width 0.5s ease;"></div>
                        </div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 2px;" id="studentExpText">0 / 5 EXP</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3><i class="fa-solid fa-calendar-check" style="color:var(--warning)"></i> IMAX ì¼ì¼í€˜ìŠ¤íŠ¸</h3>
            <ul class="assignment-list" id="assignmentList">
                <p class="loading" id="assignmentLoading"><i class="fas fa-spinner fa-spin"></i> ì¼í€˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </ul>
        </div>

        <!-- ìµœì´ˆ ë ˆë²¨ ë‹¬ì„±ì ê³µì§€ -->
        <div class="card" id="firstAchieversCard" style="display: none; background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); border: 3px solid #ff6b6b;">
            <h3 style="color: #ff6b6b;"><i class="fa-solid fa-trophy"></i> ğŸ† ìµœì´ˆ ë ˆë²¨ ë‹¬ì„±ì ğŸ†</h3>
            <div id="firstAchieversList" style="color: #333;"></div>
        </div>

        <div class="card">
            <h3><i class="fa-solid fa-bullhorn" style="color:var(--info)"></i> IMAX ê³µì§€ì‚¬í•­</h3>
            <div class="notice-list" id="noticeList">
                <p class="loading" id="noticeLoading"><i class="fas fa-spinner fa-spin"></i> ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
        </div>

        <div class="quick-actions">
            <a href="practical.html" class="action-btn" target="_self">
                <i class="fa-solid fa-chart-line"></i>
                <span>í›ˆë ¨ì¼ì§€</span>
            </a>
            <a href="search.html" class="action-btn" target="_self">
                <i class="fa-solid fa-graduation-cap"></i>
                <span>ëŒ€í•™ê²€ìƒ‰</span>
            </a>
        </div>
    </div>

    <div class="modal-overlay" id="noticeModalOverlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalNoticeTitle">ê³µì§€ ì œëª©</h3>
                <button class="close-btn" onclick="closeNoticeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="notice-meta">
                    <span id="modalNoticeAuthor">ì‘ì„±ì: ì•„ë¬´ê°œ</span> |
                    <span id="modalNoticeDate">ì‘ì„±ì¼: YYYY-MM-DD</span>
                </div>
                <hr>
                <div id="modalNoticeContent" class="notice-content-area">
                    ê³µì§€ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                </div>
            </div>
        </div>
    </div>

    <div class="quest-complete-overlay" id="questCompleteOverlay" onclick="closeQuestAnimation()">
        <div class="quest-complete-message" onclick="event.stopPropagation()">
            <i class="fa-solid fa-trophy"></i> <h2>ì¼ì¼ í€˜ìŠ¤íŠ¸ ì™„ë£Œ!</h2>
            <p>ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ì„ ëª¨ë‘ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!</p>
        </div>
    </div>

    <!-- ë ˆë²¨ì—… ì¶•í•˜ ëª¨ë‹¬ -->
    <div class="levelup-overlay" id="levelupOverlay">
        <div class="levelup-modal">
            <div class="levelup-icon">ğŸ’¥ğŸ‘Šâš¡</div>
            <div class="levelup-title">LEVEL UP!</div>
            <div class="levelup-subtitle">ğŸ”¥ íŒŒì›Œ ì—…! ğŸ”¥</div>
            <div class="levelup-levels">
                <span id="levelupOldLevel">1</span>
                <span class="levelup-arrow">âš¡â†’âš¡</span>
                <span id="levelupNewLevel">2</span>
            </div>
            <div class="levelup-exp" id="levelupExpText">ê²½í—˜ì¹˜ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!</div>
            <button class="levelup-close-btn" onclick="closeLevelupModal()">ğŸ’ª í™•ì¸ ğŸ’ª</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>


    <script>
        // --- 0. ì„¤ì • ---
        const JUNGSI_SVR = 'https://supermax.kr';
        const token = localStorage.getItem('jwt_token');

        // --- 1. DOM ìš”ì†Œ ---
        const studentNameEl = document.getElementById('studentName');
        const branchLogoEl = document.getElementById('branchLogo');
        const branchWelcomeTextEl = document.querySelector('.welcome-text p');
        const assignmentListEl = document.getElementById('assignmentList');
        const assignmentLoadingEl = document.getElementById('assignmentLoading');
        const noticeListEl = document.getElementById('noticeList');
        const noticeLoadingEl = document.getElementById('noticeLoading');
        
        const noticeModalOverlay = document.getElementById('noticeModalOverlay');
        const modalNoticeTitle = document.getElementById('modalNoticeTitle');
        const modalNoticeAuthor = document.getElementById('modalNoticeAuthor');
        const modalNoticeDate = document.getElementById('modalNoticeDate');
        const modalNoticeContent = document.getElementById('modalNoticeContent');

        let allNoticesMap = {};

        // â­ï¸ [ìˆ˜ì •] í€˜ìŠ¤íŠ¸ ì™„ë£Œ ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
        let allQuestsWereAlreadyDone = false;

        // --- 2. í—¬í¼ í•¨ìˆ˜ ---
        function showToast(message, isSuccess = true) {
            const t = document.createElement('div'); t.textContent = message;
            t.className = `toast-popup ${isSuccess ? 'success' : 'error'}`;
            document.body.appendChild(t); setTimeout(() => { t.classList.add('show'); }, 10);
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => { if (document.body.contains(t)) document.body.removeChild(t); }, 500); }, 2500);
        }

        // â­ï¸ [ì‹ ê·œ] í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì• ë‹ˆë©”ì´ì…˜ ê´€ë ¨ í•¨ìˆ˜ (í­ì£½ ë²„ì „) â­ï¸
        /**
         * â­ï¸ í€˜ìŠ¤íŠ¸ ì™„ë£Œ ì• ë‹ˆë©”ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” ë©”ì¸ í•¨ìˆ˜
         */
        function triggerQuestAnimation() {
            const overlay = document.getElementById('questCompleteOverlay');
            if (!overlay || overlay.classList.contains('show')) return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë³µ ë°©ì§€

            // 1. ì˜¤ë²„ë ˆì´ì™€ ë©”ì‹œì§€ í‘œì‹œ
            overlay.classList.add('show');

            // 2. í­ì£½ ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰ (ë¼ì´ë¸ŒëŸ¬ë¦¬)
            
            // 2-1. ì¤‘ì•™ì—ì„œ ê°•í•˜ê²Œ ë°œì‚¬ (ë” ë©‹ì§€ê²Œ ìˆ˜ì •)
            confetti({
                particleCount: 150, // íŒŒí‹°í´ ìˆ˜ ì¦ê°€
                spread: 120, // ë” ë„“ê²Œ í¼ì§
                startVelocity: 40, // ë” ì„¸ê²Œ
                origin: { y: 0.6 },
                scalar: 1.2,
                colors: ['#4361ee', '#4cc9f0', '#f8961e', '#f72585', '#ffffff', '#28a745'] // ìƒ‰ìƒ ì¶”ê°€
            });

            // 2-2. í™”ë©´ ì–‘ìª½ì—ì„œ í©ë‚ ë¦¬ê¸° (ë” ë©‹ì§€ê²Œ ìˆ˜ì •)
            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }
            
            const animationEnd = Date.now() + 2500; // 2.5ì´ˆê°„ ì§€ì†
            const interval = setInterval(function() {
                if (Date.now() > animationEnd) {
                    return clearInterval(interval);
                }
                // ì™¼ìª½ì—ì„œ ë°œì‚¬
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: randomInRange(40, 70), // í¼ì§€ëŠ” ê°ë„ ëœë¤
                    origin: { x: 0, y: randomInRange(0.6, 0.9) }, // Yì¶• ìœ„ì¹˜ ëœë¤
                    colors: ['#4361ee', '#f8961e', '#ffffff']
                });
                // ì˜¤ë¥¸ìª½ì—ì„œ ë°œì‚¬
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: randomInRange(40, 70),
                    origin: { x: 1, y: randomInRange(0.6, 0.9) },
                    colors: ['#4cc9f0', '#f72585', '#28a745']
                });
            }, 200); // 0.2ì´ˆë§ˆë‹¤


            // 3. 3.5ì´ˆ ë’¤ì— ìë™ìœ¼ë¡œ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                closeQuestAnimation();
            }, 3500);
        }

        /**
         * â­ï¸ ì• ë‹ˆë©”ì´ì…˜ ë‹«ê¸° í•¨ìˆ˜ (í´ë¦­ ë˜ëŠ” ì‹œê°„ ì´ˆê³¼ ì‹œ)
         */
        function closeQuestAnimation() {
            const overlay = document.getElementById('questCompleteOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }
        window.closeQuestAnimation = closeQuestAnimation; // ì „ì—­ ë…¸ì¶œ (HTML onclickìš©)

        /**
         * â­ï¸ [ìˆ˜ì •] í˜„ì¬ DOMì˜ ëª¨ë“  í€˜ìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸ (true/false ë°˜í™˜)
         */
        function areAllQuestsDoneNow() {
            const questListContainer = document.getElementById('assignmentList'); 
            if (!questListContainer) return false; 

            const allCheckboxes = questListContainer.querySelectorAll('.assignment-item input[type="checkbox"]');
            if (allCheckboxes.length === 0) return false; // í€˜ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ 'ì™„ë£Œ'ê°€ ì•„ë‹˜

            // ëª¨ë“  ì²´í¬ë°•ìŠ¤ê°€ :checked ìƒíƒœì¸ì§€ í™•ì¸
            return Array.from(allCheckboxes).every(cb => cb.checked);
        }
        // â­ï¸ [ì‹ ê·œ] ì• ë‹ˆë©”ì´ì…˜ ê´€ë ¨ í•¨ìˆ˜ ë â­ï¸


        // --- 3. ë°ì´í„° ë¡œë”© ë° ë Œë”ë§ í•¨ìˆ˜ ---

        // â­ï¸ [ìˆ˜ì •] ì˜¤ëŠ˜ í• ë‹¹ëœ ìš´ë™ ëª©ë¡ API í˜¸ì¶œ (ì™„ë£Œ ì²´í¬ ë¡œì§ ìˆ˜ì •)
        async function loadAssignments() {
            if (!token) return;
            try {
                assignmentLoadingEl.style.display = 'block';
                assignmentListEl.innerHTML = '';
                assignmentListEl.appendChild(assignmentLoadingEl);
                
                const res = await fetch(`${JUNGSI_SVR}/jungsi/student/today-assignment`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(`[${res.status}] ${data.message || 'ìš´ë™ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨'}`);
                if (!data.success) throw new Error(data.message || 'ìš´ë™ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ (Success: false)');
                
                assignmentLoadingEl.style.display = 'none';
                assignmentListEl.innerHTML = '';

                const assignments = data.assignments || [];
                if (assignments.length === 0) {
                    assignmentListEl.innerHTML = '<p class="no-data">ì˜¤ëŠ˜ í• ë‹¹ëœ ìš´ë™ì´ ì—†ìŠµë‹ˆë‹¤.</p';
                    // â­ï¸ [ì‹ ê·œ] í€˜ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´, 'ì™„ë£Œ' ìƒíƒœë„ falseë¡œ ì´ˆê¸°í™”
                    allQuestsWereAlreadyDone = false;
                    return;
                }
                
                assignments.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'assignment-item';
                    if (item.is_completed) { li.classList.add('completed'); }
                    li.dataset.assignmentId = item.assignment_id;

                    let targetInfo = '';
                    if (item.category === 'Weight') { targetInfo = `${item.target_weight || '-'}kg ${item.target_sets || '-'}x${item.target_reps || '-'}`; }
                    else if (item.target_notes) { targetInfo = item.target_notes; }
                    else if (item.target_sets || item.target_reps) { targetInfo = `${item.target_sets || ''}ì„¸íŠ¸ ${item.target_reps || ''}íšŒ`; }

                    const teacherDisplay = item.teacher_name ? `${item.teacher_name} ì„ ìƒë‹˜` : (item.teacher_userid || 'ë‹´ë‹¹ì');

                    li.innerHTML = `
                        <input type="checkbox" ${item.is_completed ? 'checked' : ''} onchange="updateAssignmentStatus(this, ${item.assignment_id})">
                        <div class="assignment-details">
                            <span class="exercise-name">${item.exercise_name || 'ìš´ë™ëª… ì—†ìŒ'}</span>
                            <span class="target-info">${targetInfo || 'ì„¸ë¶€ ì •ë³´ ì—†ìŒ'}</span>
                            <span class="teacher-name">í• ë‹¹: ${teacherDisplay}</span>
                        </div>
                    `;
                    assignmentListEl.appendChild(li);
                });

                // â­ï¸ [ìˆ˜ì •] í€˜ìŠ¤íŠ¸ ëª©ë¡ ë¡œë“œ ì™„ë£Œ í›„, í˜„ì¬ ì™„ë£Œ ìƒíƒœë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                setTimeout(() => {
                    allQuestsWereAlreadyDone = areAllQuestsDoneNow();
                    console.log("í˜ì´ì§€ ë¡œë“œ. í˜„ì¬ í€˜ìŠ¤íŠ¸ ì™„ë£Œ ìƒíƒœ:", allQuestsWereAlreadyDone);
                }, 100); 

            } catch (err) {
                console.error("ì˜¤ëŠ˜ ìš´ë™ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", err);
                assignmentLoadingEl.style.display = 'none';
                assignmentListEl.innerHTML = `<p class="no-data" style="color:var(--danger)">ìš´ë™ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>`;
            }
        }

        // ê³µì§€ì‚¬í•­ ëª©ë¡ API í˜¸ì¶œ ë° í™”ë©´ ë Œë”ë§
        async function loadNotices() {
            if (!token) return;
            try {
                noticeLoadingEl.style.display = 'block';
                noticeListEl.innerHTML = '';
                noticeListEl.appendChild(noticeLoadingEl);
                allNoticesMap = {}; 

                const res = await fetch(`${JUNGSI_SVR}/jungsi/student/announcements`, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(`[${res.status}] ${data.message || 'ê³µì§€ ë¡œë“œ ì‹¤íŒ¨'}`);
                if (!data.success) throw new Error(data.message || 'ê³µì§€ ë¡œë“œ ì‹¤íŒ¨ (Success: false)');
                
                noticeLoadingEl.style.display = 'none';
                noticeListEl.innerHTML = ''; 

                const notices = data.announcements || [];
                if (notices.length === 0) {
                    noticeListEl.innerHTML = '<p class="no-data">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                notices.forEach(notice => {
                    allNoticesMap[notice.notice_id] = notice;
                });

                // â­ï¸ [ìˆ˜ì •] ìµœì‹  3ê°œ í‘œì‹œ, ì²« ë²ˆì§¸ í•­ëª©(index 0)ì— 'notice-newest' í´ë˜ìŠ¤ ì¶”ê°€
                notices.slice(0, 3).forEach((notice, index) => { // â­ï¸ index ì¶”ê°€
                    const button = document.createElement('button');
                    button.className = 'notice-link'; // ê¸°ë³¸ í´ë˜ìŠ¤

                    // â­ï¸ [ì‹ ê·œ] ì²« ë²ˆì§¸ ê³µì§€(index 0)ì—ë§Œ 'notice-newest' í´ë˜ìŠ¤ ì¶”ê°€
                    if (index === 0) {
                        button.classList.add('notice-newest');
                    }
                    // â­ï¸ [ì‹ ê·œ] ë
                    
                    button.onclick = () => openNoticeModal(notice.notice_id); 

                    let authorDisplay = 'ê´€ë¦¬ì';
                    if (notice.author_name) {
                        authorDisplay = `${notice.author_name} ì„ ìƒë‹˜`;
                    } else if (notice.created_by) {
                         authorDisplay = notice.created_by === 'sean8320' ? 'ì›ì¥ë‹˜' : `${notice.created_by}`;
                    }

                    button.innerHTML = `
                        <span class="notice-title">${notice.title || 'ì œëª© ì—†ìŒ'}</span>
                        <span class="notice-author">ì‘ì„±ì: ${authorDisplay}</span>
                    `;
                    noticeListEl.appendChild(button);
                });
            } catch (err) {
                 console.error("ê³µì§€ì‚¬í•­ ë¡œë”© ì‹¤íŒ¨:", err);
                 noticeLoadingEl.style.display = 'none';
                 noticeListEl.innerHTML = `<p class="no-data" style="color:var(--danger)">ê³µì§€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>`;
            }
        }

        // â­ï¸ [ìˆ˜ì •] ìš´ë™ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±° ë¡œì§ ë³€ê²½)
        async function updateAssignmentStatus(checkboxElement, assignmentId) {
             if (!token) return;
            const isCompleted = checkboxElement.checked;
            const listItem = checkboxElement.closest('.assignment-item');
            
            listItem.classList.toggle('completed', isCompleted);
            checkboxElement.disabled = true;
            
            try {
                const res = await fetch(`${JUNGSI_SVR}/jungsi/student/assignment/complete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ assignment_id: assignmentId, is_completed: isCompleted })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(`[${res.status}] ${data.message || 'ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨'}`);
                if (!data.success) throw new Error(data.message || 'ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (Success: false)');

                // â­ï¸ ë ˆë²¨ ì •ë³´ ì—…ë°ì´íŠ¸
                if (data.levelInfo) {
                    loadStudentLevel(); // ë ˆë²¨ ì •ë³´ ìƒˆë¡œê³ ì¹¨

                    // ë ˆë²¨ì—… í–ˆìœ¼ë©´ ì¶•í•˜ ëª¨ë‹¬ í‘œì‹œ
                    if (data.levelInfo.leveledUp) {
                        showLevelupModal(
                            data.levelInfo.oldLevel,
                            data.levelInfo.newLevel,
                            data.levelInfo.currentExp,
                            data.levelInfo.expForNextLevel,
                            data.levelInfo.isFirstAchiever || false
                        );
                    }
                }

                // â­ï¸ [ì‹ ê·œ] API í˜¸ì¶œ ì„±ê³µ í›„, ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±° ë¡œì§
                
                // 1. í˜„ì¬ DOM ìƒíƒœê°€ "ëª¨ë‘ ì™„ë£Œ"ì¸ì§€ ë‹¤ì‹œ í™•ì¸
                const allDoneNow = areAllQuestsDoneNow();

                if (allDoneNow) {
                    // 2. "ëª¨ë‘ ì™„ë£Œ" ìƒíƒœê°€ ë˜ì—ˆë‹¤ë©´, "ì´ì „ì—ë„" ì™„ë£Œ ìƒíƒœì˜€ëŠ”ì§€ í™•ì¸
                    if (!allQuestsWereAlreadyDone) {
                        // 3. â­ï¸ ì´ì „ì—” ì•„ë‹ˆì—ˆëŠ”ë°(false) ì§€ê¸ˆ ì™„ë£Œ(true)ëë‹¤ë©´ = "ë°©ê¸ˆ" ì™„ë£Œí•œ ê²ƒ!
                        console.log("ğŸ‰ ì¼ì¼ í€˜ìŠ¤íŠ¸ ëª¨ë‘ ì™„ë£Œ! ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰!");
                        triggerQuestAnimation(); // ì• ë‹ˆë©”ì´ì…˜ ì‹¤í–‰
                    } else {
                        console.log("í€˜ìŠ¤íŠ¸ ì™„ë£Œ. (í•˜ì§€ë§Œ ì´ë¯¸ 'ëª¨ë‘ ì™„ë£Œ' ìƒíƒœì˜€ìŒ)");
                    }
                    // 4. í˜„ì¬ ìƒíƒœë¥¼ 'ì™„ë£Œ'ë¡œ ê¸°ë¡
                    allQuestsWereAlreadyDone = true;
                } else {
                    // 5. "ëª¨ë‘ ì™„ë£Œ" ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´ (í•˜ë‚˜ë¼ë„ ì²´í¬ í•´ì œí–ˆë‹¤ë©´)
                    console.log("í€˜ìŠ¤íŠ¸ ìƒíƒœ ë³€ê²½. (ì•„ì§ ì™„ë£Œë˜ì§€ ì•ŠìŒ)");
                    allQuestsWereAlreadyDone = false; // â­ï¸ ë‹¤ìŒ ì™„ë£Œë¥¼ ìœ„í•´ 'ë¯¸ì™„ë£Œ'ë¡œ ê¸°ë¡
                }

            } catch (err) {
                console.error("ìš´ë™ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", err);
                showToast(`âŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ${err.message}`, false);
                // â­ï¸ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
                checkboxElement.checked = !isCompleted;
                listItem.classList.toggle('completed', !isCompleted);
                
                // â­ï¸ [ì‹ ê·œ] ë¡¤ë°± ì‹œ ìƒíƒœ ì¬í™•ì¸
                allQuestsWereAlreadyDone = areAllQuestsDoneNow();

            } finally {
                checkboxElement.disabled = false;
            }
        }
        window.updateAssignmentStatus = updateAssignmentStatus; // ì „ì—­ ë…¸ì¶œ

        // --- â­ï¸ ê³µì§€ì‚¬í•­ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ---
        function openNoticeModal(noticeId) {
            const notice = allNoticesMap[noticeId];
            if (!notice) {
                showToast('ê³µì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', false);
                return;
            }
            modalNoticeTitle.textContent = notice.title || 'ì œëª© ì—†ìŒ';
            let authorDisplay = 'ê´€ë¦¬ì';
            if (notice.author_name) {
                authorDisplay = `${notice.author_name} ì„ ìƒë‹˜`;
            } else if (notice.created_by) {
                authorDisplay = notice.created_by === 'sean8320' ? 'ì›ì¥ë‹˜' : `${notice.created_by}`;
            }
            modalNoticeAuthor.textContent = `ì‘ì„±ì: ${authorDisplay}`;
            try {
                 modalNoticeDate.textContent = `ì‘ì„±ì¼: ${new Date(notice.created_at).toISOString().split('T')[0]}`;
            } catch {
                 modalNoticeDate.textContent = 'ì‘ì„±ì¼: ì•Œ ìˆ˜ ì—†ìŒ';
            }
            modalNoticeContent.textContent = notice.content || '(ë‚´ìš© ì—†ìŒ)';
            noticeModalOverlay.classList.add('show');
        }
        window.openNoticeModal = openNoticeModal;

        function closeNoticeModal() {
            noticeModalOverlay.classList.remove('show');
        }
        window.closeNoticeModal = closeNoticeModal;

        noticeModalOverlay.addEventListener('click', (event) => {
            if (event.target === noticeModalOverlay) {
                closeNoticeModal();
            }
        });
        // --- â­ï¸ ê³µì§€ì‚¬í•­ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ë ---

        // --- ë ˆë²¨ì—… ì¶•í•˜ ëª¨ë‹¬ í•¨ìˆ˜ ---
        function showLevelupModal(oldLevel, newLevel, currentExp, nextLevelExp, isFirstAchiever = false) {
            const overlay = document.getElementById('levelupOverlay');
            const modal = overlay.querySelector('.levelup-modal');

            document.getElementById('levelupOldLevel').textContent = oldLevel;
            document.getElementById('levelupNewLevel').textContent = newLevel;

            // ìµœì´ˆ ë‹¬ì„±ì íŠ¹ë³„ ìŠ¤íƒ€ì¼
            if (isFirstAchiever) {
                modal.style.background = 'linear-gradient(135deg, #ffd700 0%, #ff6b6b 50%, #ffd700 100%)';
                modal.style.border = '5px solid #ff0000';
                modal.style.boxShadow = '0 0 100px rgba(255, 215, 0, 0.9), 0 0 200px rgba(255, 0, 0, 0.6)';
                document.getElementById('levelupExpText').textContent = `ğŸ†ğŸ† ìµœì´ˆ ë‹¬ì„±ì! ğŸ†ğŸ†`;
                document.querySelector('.levelup-subtitle').textContent = 'ğŸ”¥ğŸ”¥ ì—­ëŒ€ ìµœì´ˆ ë ˆë²¨ ë‹¬ì„±! ğŸ”¥ğŸ”¥';
            } else {
                // ì¼ë°˜ ë ˆë²¨ì—… ìŠ¤íƒ€ì¼ ë³µêµ¬
                modal.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ffd93d 50%, #ff6b6b 100%)';
                modal.style.border = '3px solid #ffd700';
                modal.style.boxShadow = '0 20px 60px rgba(255, 107, 107, 0.5), 0 0 100px rgba(255, 217, 61, 0.4)';
                document.querySelector('.levelup-subtitle').textContent = 'ğŸ”¥ íŒŒì›Œ ì—…! ğŸ”¥';

                if (nextLevelExp) {
                    document.getElementById('levelupExpText').textContent = `âš¡ ${currentExp} / ${nextLevelExp} EXP âš¡`;
                } else {
                    document.getElementById('levelupExpText').textContent = `ğŸ† ë§Œë ™ ë‹¬ì„±! ì´ ${currentExp} EXP ğŸ†`;
                }
            }

            overlay.classList.add('show');

            // ğŸ† ì´ˆë°˜ í­ë°œ íš¨ê³¼
            if (isFirstAchiever) {
                // ìµœì´ˆ ë‹¬ì„±ì íŠ¹ë³„ í­ë°œ (ë” ë§ì´!)
                confetti({
                    particleCount: 200,
                    spread: 180,
                    origin: { y: 0.5 },
                    colors: ['#ffd700', '#ff0000', '#ff9500', '#ffed4e'],
                    startVelocity: 60
                });
            } else {
                confetti({
                    particleCount: 100,
                    spread: 160,
                    origin: { y: 0.5 },
                    colors: ['#ffd700', '#ff6b6b', '#ff9500', '#ff0000', '#ffed4e']
                });
            }

            // ğŸ‡ ì—°ì† confetti íš¨ê³¼
            const duration = isFirstAchiever ? 6000 : 4000; // ìµœì´ˆ ë‹¬ì„±ìëŠ” 6ì´ˆ!
            const end = Date.now() + duration;

            (function frame() {
                const particleMultiplier = isFirstAchiever ? 2 : 1; // ìµœì´ˆ ë‹¬ì„±ìëŠ” 2ë°°

                // ì™¼ìª½ì—ì„œ
                confetti({
                    particleCount: 10 * particleMultiplier,
                    angle: 60,
                    spread: 70,
                    origin: { x: 0, y: 0.8 },
                    colors: isFirstAchiever ? ['#ffd700', '#ff0000', '#ffed4e'] : ['#ffd700', '#ff6b6b', '#ff9500'],
                    startVelocity: isFirstAchiever ? 60 : 45
                });
                // ì˜¤ë¥¸ìª½ì—ì„œ
                confetti({
                    particleCount: 10 * particleMultiplier,
                    angle: 120,
                    spread: 70,
                    origin: { x: 1, y: 0.8 },
                    colors: isFirstAchiever ? ['#ffd700', '#ff0000', '#ffed4e'] : ['#ffd700', '#ff6b6b', '#ff9500'],
                    startVelocity: isFirstAchiever ? 60 : 45
                });
                // ì¤‘ì•™ í­ë°œ
                const explosionChance = isFirstAchiever ? 0.5 : 0.7; // ìµœì´ˆ ë‹¬ì„±ìëŠ” ë” ìì£¼ í­ë°œ
                if (Math.random() > explosionChance) {
                    confetti({
                        particleCount: 30 * particleMultiplier,
                        spread: 360,
                        origin: { y: 0.3 },
                        colors: isFirstAchiever ? ['#ffd700', '#ff0000', '#ffed4e'] : ['#ffd700', '#ff0000', '#ff9500'],
                        startVelocity: isFirstAchiever ? 50 : 30
                    });
                }

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());

            // ìµœì´ˆ ë‹¬ì„±ìëŠ” í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ë‹¤ë¥¸ í•™ìƒë“¤ì—ê²Œ ê³µì§€ í‘œì‹œ)
            if (isFirstAchiever) {
                setTimeout(() => {
                    loadFirstAchievers(); // ìµœì´ˆ ë‹¬ì„±ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                }, 1000);
            }
        }
        window.showLevelupModal = showLevelupModal;

        function closeLevelupModal() {
            document.getElementById('levelupOverlay').classList.remove('show');
        }
        window.closeLevelupModal = closeLevelupModal;

        // --- ìµœì´ˆ ë‹¬ì„±ì ë¡œë“œ í•¨ìˆ˜ ---
        async function loadFirstAchievers() {
            try {
                const response = await fetch('https://supermax.kr/jungsi/level/first-achievers', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    console.warn('ìµœì´ˆ ë‹¬ì„±ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const data = await response.json();
                if (data.success && data.achievers.length > 0) {
                    const card = document.getElementById('firstAchieversCard');
                    const list = document.getElementById('firstAchieversList');

                    let html = '';
                    data.achievers.forEach(achiever => {
                        const date = new Date(achiever.achieved_at);
                        const timeAgo = getTimeAgo(date);
                        html += `
                            <div style="padding: 12px; border-bottom: 1px dashed rgba(255,107,107,0.3); display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 700; font-size: 16px; color: #ff6b6b;">
                                        ğŸ† ${achiever.student_name}ë‹˜ - Lv.${achiever.level} ìµœì´ˆ ë‹¬ì„±!
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                        ${achiever.branch || ''} | ${timeAgo}
                                    </div>
                                </div>
                                <div style="font-size: 36px;">âš¡</div>
                            </div>
                        `;
                    });

                    list.innerHTML = html;
                    card.style.display = 'block';
                }
            } catch (error) {
                console.error('ìµœì´ˆ ë‹¬ì„±ì ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'ë°©ê¸ˆ ì „';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}ë¶„ ì „`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}ì‹œê°„ ì „`;
            const days = Math.floor(hours / 24);
            return `${days}ì¼ ì „`;
        }

        // --- ë ˆë²¨ ì •ë³´ ë¡œë“œ í•¨ìˆ˜ ---
        async function loadStudentLevel() {
            try {
                const response = await fetch('https://supermax.kr/jungsi/student/level', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    console.warn('ë ˆë²¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    const level = data.level;

                    // ë ˆë²¨ í‘œì‹œ
                    document.getElementById('studentLevel').textContent = level.current_level;

                    // ë§Œë ™ ì²´í¬
                    if (level.is_max_level) {
                        document.getElementById('studentExpText').textContent = `${level.current_exp} EXP (ë§Œë ™!)`;
                        document.getElementById('studentExpBar').style.width = '100%';
                    } else {
                        // ê²½í—˜ì¹˜ ë°” ì—…ë°ì´íŠ¸
                        const progress = level.progress_percentage || 0;
                        document.getElementById('studentExpText').textContent = `${level.current_exp} / ${level.exp_for_next_level} EXP`;
                        document.getElementById('studentExpBar').style.width = `${progress}%`;
                    }
                }
            } catch (error) {
                console.error('ë ˆë²¨ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // --- 4. í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰ ---
        document.addEventListener('DOMContentLoaded', () => {
            if (token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    const payload = JSON.parse(jsonPayload);

                    studentNameEl.textContent = payload.name || 'í•™ìƒ';
                    if (branchWelcomeTextEl) {
                        branchWelcomeTextEl.textContent = payload.branch ? `MAX ${payload.branch.toUpperCase()}` : 'MAX';
                    }
                    
                    const logoImg = document.getElementById('branchLogo');
                    logoImg.onerror = () => {
                        console.warn('ë¡œê³  ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨. í…ìŠ¤íŠ¸ ë¡œê³ ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.');
                        const tempTextLogo = document.createElement('div');
                        tempTextLogo.id = 'branchLogoTextDiv';
                        tempTextLogo.textContent = payload.branch ? payload.branch.substring(0, 3).toUpperCase() : 'MAX';
                        logoImg.parentNode.replaceChild(tempTextLogo, logoImg);
                    };
                    
                    let logoUrl = 'https://github.com/seanyjeong/ilsanmaxstudent/blob/main/ilsanmax.png?raw=true'; // ê¸°ë³¸ ë¡œê³ 
                    if (payload.branch === 'í•˜ë‚¨') {
                         logoUrl = 'https://github.com/seanyjeong/ilsanmaxstudent/blob/main/hanammax.png?raw=true';
                    }
                    // (ë‹¤ë¥¸ ì§€ì  ë¡œê³  ì¶”ê°€)
                    
                    logoImg.src = logoUrl;

                } catch (error) {
                    console.error("í† í° ë””ì½”ë”© ì˜¤ë¥˜:", error);
                    studentNameEl.textContent = 'í•™ìƒ';
                    if (branchWelcomeTextEl) branchWelcomeTextEl.textContent = 'MAX';
                    
                    const logoImg = document.getElementById('branchLogo');
                    const tempTextLogo = document.createElement('div');
                    tempTextLogo.id = 'branchLogoTextDiv';
                    tempTextLogo.textContent = 'MAX';
                    if(logoImg) logoImg.parentNode.replaceChild(tempTextLogo, logoImg);
                }
            } else {
                 console.warn("ë¡œê·¸ì¸ í† í°ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                 studentNameEl.textContent = 'ë°©ë¬¸ì';
                 if (branchWelcomeTextEl) branchWelcomeTextEl.textContent = 'MAX';
                 
                 const logoImg = document.getElementById('branchLogo');
                 const tempTextLogo = document.createElement('div');
                 tempTextLogo.id = 'branchLogoTextDiv';
                 tempTextLogo.textContent = 'ERR';
                 if(logoImg) logoImg.parentNode.replaceChild(tempTextLogo, logoImg);

                 assignmentLoadingEl.style.display = 'none';
                 assignmentListEl.innerHTML = '<p class="no-data">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>';
                 noticeLoadingEl.style.display = 'none';
                 noticeListEl.innerHTML = '<p class="no-data">ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>';
                 return;
            }

            // ë°ì´í„° ë¡œë“œ ì‹œì‘
            loadStudentLevel();
            loadFirstAchievers();
            loadAssignments();
            loadNotices();
        });

    </script>
</body>
</html>
