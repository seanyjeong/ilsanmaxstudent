<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>학생 회원가입</title>
<style>
body { font-family: sans-serif; max-width:400px; margin:30px auto; line-height:1.4; }
label { font-weight:600; display:block; margin-top:16px; }
input, select { width:100%; padding:10px; font-size:1rem; margin-top:6px; box-sizing:border-box; }
button { width:100%; padding:12px; margin-top:16px; font-size:1rem; font-weight:600; cursor:pointer; border:0; border-radius:6px; }
button.primary { background:#2563eb; color:#fff; }
button.secondary { background:#475569; color:#fff; }
.small-row { display:flex; gap:8px; align-items:flex-end; }
.small-row input { flex:1; }
.status-msg { font-size:.9rem; margin-top:4px; min-height:18px; color:#555; }
.ok { color:#10b981; }
.err { color:#ef4444; }
.note { font-size:.8rem; color:#64748b; line-height:1.3; margin-top:4px; }
#branchOtherInput { display: none; margin-top: 8px; } /* 기타 지점 입력칸 숨김 */
</style>
</head>
<body>

<h2>I-MAX 회원가입</h2>
<p style="font-size:.9rem;color:#555;">휴대폰 인증 후 가입 가능합니다.<br>가입신청 후 원장님께 말씀해주세요.</p>

<label>아이디</label>
<div class="small-row">
  <input type="text" id="userid" placeholder="아이디(영문+숫자)">
  <button class="secondary" id="checkIdBtn" style="flex:0 0 auto;width:auto;padding:10px 12px;font-size:.9rem;">중복확인</button>
</div>
<div class="status-msg" id="useridStatus"></div>

<label>비밀번호</label>
<input type="password" id="password" placeholder="비밀번호 (숫자/영문 조합 추천)">

<label>비밀번호 확인</label>
<input type="password" id="passwordConfirm" placeholder="비밀번호 다시 입력">
<div class="status-msg" id="passwordStatus"></div>

<label>이름</label>
<input type="text" id="name" placeholder="이름 (실명)">

<label>출신고교</label>
<input type="text" id="school" placeholder="예: 맥스고 (선택사항)">

<label>지점명</label>
<select id="branchSelect">
  <option value="">지점 선택 (필수)</option>
  <option value="일산">일산</option>
  <option value="기타">기타 (직접 입력)</option>
</select>
<input type="text" id="branchOtherInput" placeholder="지점명을 입력하세요">

<label>학년</label>
<select id="grade">
  <option value="">학년 선택 (필수)</option>
  <option value="1">고1</option>
  <option value="2">고2</option>
  <option value="3">고3</option>
  <option value="N">N수</option>
</select>

<label>성별</label>
<select id="gender">
  <option value="">성별 선택 (필수)</option>
  <option value="남">남</option>
  <option value="여">여</option>
</select>

<label>휴대폰 번호</label>
<div class="small-row">
  <input type="tel" id="phone" placeholder="01012345678">
  <button class="secondary" id="sendCodeBtn" style="flex:0 0 auto;width:auto;padding:10px 12px;font-size:.9rem;">인증요청</button>
</div>
<div class="status-msg" id="smsStatus"></div>
<div class="note">※ 본인 번호로만 가입 가능. 부모님 번호 안 돼요.</div>

<label>인증번호</label>
<div class="small-row">
  <input type="text" id="code" placeholder="4자리">
  <button class="secondary" id="verifyBtn" style="flex:0 0 auto;width:auto;padding:10px 12px;font-size:.9rem;">인증확인</button>
</div>
<div class="status-msg" id="codeStatus"></div>

<button class="primary" id="registerBtn" disabled>가입 신청</button>

<div class="status-msg" id="finalMsg" style="margin-top:24px;font-size:1rem;"></div>

<script>
const SVR = 'https://supermax.kr';

let idAvailable = false;
let phoneVerified = false;

// 지점 드롭다운 및 기타 입력칸 요소 가져오기
const branchSelect = document.getElementById('branchSelect');
const branchOtherInput = document.getElementById('branchOtherInput');

// 지점 드롭다운 변경 시 이벤트 리스너
branchSelect.addEventListener('change', () => {
  if (branchSelect.value === '기타') {
    branchOtherInput.style.display = 'block';
  } else {
    branchOtherInput.style.display = 'none';
    branchOtherInput.value = '';
  }
});

// --- helper 함수 정의 (먼저 정의해야 함) ---
function setMsg(id, text, type) {
  const el = document.getElementById(id);
  el.textContent = text;
  el.className = 'status-msg ' + (type === 'ok' ? 'ok' : 'err');
}

function syncRegisterButton() {
  const btn = document.getElementById('registerBtn');
  // ⭐️ 비밀번호 일치 여부도 버튼 활성화 조건에 추가 (선택 사항)
  // const passwordsMatch = document.getElementById('password').value === document.getElementById('passwordConfirm').value && document.getElementById('passwordConfirm').value !== '';
  // if (idAvailable && phoneVerified && passwordsMatch) {
  if (idAvailable && phoneVerified) { // 일단 아이디/폰 인증만 확인
    btn.disabled = false;
  } else {
    btn.disabled = true;
  }
}
// --- helper 함수 정의 끝 ---

// --- 비밀번호 실시간 확인 로직 ---
const passwordInput = document.getElementById('password');
const passwordConfirmInput = document.getElementById('passwordConfirm');
const passwordStatusEl = document.getElementById('passwordStatus');

function checkPasswordMatch() {
  const password = passwordInput.value;
  const confirmPassword = passwordConfirmInput.value;

  if (confirmPassword === '') {
    setMsg('passwordStatus', '', 'ok');
  } else if (password === confirmPassword) {
    setMsg('passwordStatus', '비밀번호가 일치합니다.', 'ok');
  } else {
    setMsg('passwordStatus', '비밀번호가 일치하지 않습니다.', 'err');
  }
  // syncRegisterButton(); // 비밀번호 일치 여부를 버튼 활성화 조건으로 삼으려면 주석 해제
}

// 비밀번호 확인 입력칸에 입력할 때마다 검사
passwordConfirmInput.addEventListener('input', checkPasswordMatch);
// 원본 비밀번호 입력칸에 입력할 때도 검사
passwordInput.addEventListener('input', checkPasswordMatch);
// --- 비밀번호 실시간 확인 로직 끝 ---

// 1) 아이디 중복확인
document.getElementById('checkIdBtn').addEventListener('click', async () => {
  const userid = document.getElementById('userid').value.trim();
  if (!userid) {
    setMsg('useridStatus', '아이디를 입력하세요.', 'err');
    idAvailable = false;
    syncRegisterButton();
    return;
  }
  const res = await fetch(`${SVR}/26susi_student/check-userid`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userid }) });
  const data = await res.json();
  if (data.success && data.available) {
    idAvailable = true;
    setMsg('useridStatus', '사용 가능한 아이디입니다.', 'ok');
  } else {
    idAvailable = false;
    setMsg('useridStatus', data.message || '이미 사용중인 아이디입니다.', 'err');
  }
  syncRegisterButton();
});

// 2) 휴대폰 인증번호 요청
document.getElementById('sendCodeBtn').addEventListener('click', async () => {
  const phone = document.getElementById('phone').value.trim();
  if (!phone) {
    setMsg('smsStatus', '전화번호를 입력하세요.', 'err'); return;
  }
  const res = await fetch(`${SVR}/26susi/send-verification-sms`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ phone }) });
  const data = await res.json();
  if (data.success) {
    setMsg('smsStatus', '인증번호를 전송했습니다.', 'ok');
  } else {
    setMsg('smsStatus', data.message || '발송 실패', 'err');
  }
});

// 3) 인증번호 확인
document.getElementById('verifyBtn').addEventListener('click', async () => {
  const phone = document.getElementById('phone').value.trim();
  const code = document.getElementById('code').value.trim();
  if (!phone || !code) {
    setMsg('codeStatus', '전화번호/코드 모두 입력하세요.', 'err');
    phoneVerified = false; syncRegisterButton(); return;
  }
  const res = await fetch(`${SVR}/26susi/verify-code`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ phone, code }) });
  const data = await res.json();
  if (data.success) {
    phoneVerified = true;
    setMsg('codeStatus', '번호 인증 완료!', 'ok');
  } else {
    phoneVerified = false;
    setMsg('codeStatus', data.message || '인증 실패', 'err');
  }
  syncRegisterButton();
});

// 4) 가입 신청
document.getElementById('registerBtn').addEventListener('click', async () => {
  const userid = document.getElementById('userid').value.trim();
  const password = document.getElementById('password').value.trim();
  const passwordConfirm = document.getElementById('passwordConfirm').value.trim();
  const name = document.getElementById('name').value.trim();
  const school = document.getElementById('school').value.trim();
  let branch = '';
  if (branchSelect.value === '기타') {
    branch = branchOtherInput.value.trim();
  } else {
    branch = branchSelect.value;
  }
  const grade = document.getElementById('grade').value;
  const phone = document.getElementById('phone').value.trim();
  const gender = document.getElementById('gender').value;

  // 가입 신청 시 최종 비밀번호 확인
  if (password !== passwordConfirm) {
    setMsg('passwordStatus', '비밀번호가 일치하지 않습니다.', 'err');
    // 스크롤을 비밀번호 확인란으로 이동 (선택 사항)
    passwordConfirmInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
    passwordConfirmInput.focus();
    return;
  }

  // 필수 항목 최종 확인
  if (!userid || !password || !name || !branch || !phone || !gender || !grade) {
    setMsg('finalMsg', '빈칸 없이 모두 입력해주세요. (지점명, 학년, 성별 필수)', 'err');
    return;
  }
  if (!idAvailable) {
    setMsg('finalMsg', '아이디 중복확인을 해주세요.', 'err'); return;
  }
  if (!phoneVerified) {
    setMsg('finalMsg', '휴대폰 인증을 완료해주세요.', 'err'); return;
  }

  document.getElementById('registerBtn').disabled = true;

  const res = await fetch(`${SVR}/26susi_student/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userid, password, name, school, grade, branch, phone, gender }) });
  const data = await res.json();

  if (data.success) {
    setMsg('finalMsg', '가입 신청 완료! 2초 후 로그인 페이지로 이동합니다.', 'ok');
    setTimeout(() => { location.href = 'student_login.html'; }, 2000);
  } else {
    setMsg('finalMsg', data.message || '가입 실패', 'err');
    document.getElementById('registerBtn').disabled = false;
  }
});
</script>
</body>
</html>
