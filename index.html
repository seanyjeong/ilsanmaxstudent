<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>IMAX</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="manifest" href="manifest.json" />

  <meta name="theme-color" content="#4361ee" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="IMAX" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />

  <style>
    :root {
      --primary: #4361ee; --primary-light: #4895ef; --secondary: #3f37c9;
      --success: #4cc9f0; --danger: #f72585; --warning: #f8961e;
      --dark: #1e1e2e; --light: #f8f9fa; --gray: #adb5bd; --gray-light: #e9ecef;
      --border-radius: 16px; --card-shadow: 0 8px 24px rgba(0,0,0,0.08);
      --transition: all 0.3s ease;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--light); color: var(--dark);
      display: flex; flex-direction: column;
    }
    #contentFrame { flex: 1; border: none; width: 100%; overflow-y: auto; }
    .bottom-nav {
      flex-shrink: 0; display: flex; justify-content: space-around; align-items: center;
      width: 100%; height: 70px; background-color: #fff; border-top: 1px solid var(--gray-light);
      box-shadow: 0 -4px 12px rgba(0,0,0,0.05); padding-bottom: env(safe-area-inset-bottom);
      position: relative; z-index: 100;
    }
    .nav-button {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      flex: 1; text-decoration: none; color: var(--gray); font-size: 11px; padding: 8px 0;
      transition: var(--transition); position: relative;
    }
    .nav-button i { font-size: 22px; margin-bottom: 4px; transition: var(--transition); }
    .nav-button.active { color: var(--primary); }
    .nav-button.active::after {
      content: ''; position: absolute; bottom: 0; width: 24px; height: 3px;
      background-color: var(--primary); border-radius: 2px;
    }
    .loading {
      display: none; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--success)); z-index: 1000;
      animation: loading 1.5s infinite;
    }
    @keyframes loading { 0% { transform: translateX(-100%);} 100% { transform: translateX(100%);} }
  </style>
</head>
<body>
  <div class="loading" id="loadingIndicator"></div>

  <!-- 초기 콘텐츠 (버전 쿼리 부착으로 즉시 최신 로드) -->
  <iframe id="contentFrame" src="" name="contentFrame"></iframe>

  <nav class="bottom-nav">
    <a href="#" id="nav-home"   class="nav-button active" target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-house"></i><span>홈</span></a>
    <a href="#" id="nav-search" class="nav-button"        target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-magnifying-glass"></i><span>대학찾기</span></a>
    <a href="#" id="nav-saved"  class="nav-button"        target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-star"></i><span>저장대학</span></a>
    <a href="#" id="nav-prac"   class="nav-button"        target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-person-running"></i><span>실기관리</span></a>
    <a href="#" id="nav-ranking" class="nav-button"       target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-trophy"></i><span>랭킹</span></a>
    <a href="#" id="nav-my"     class="nav-button"        target="contentFrame" onclick="setActive(this)"><i class="fa-solid fa-user"></i><span>마이페이지</span></a>
  </nav>

  <script>
    // ===== 0) 앱/배포 버전 (바꿀 때마다 문자열만 업데이트) =====
    const APP_VERSION = '2025-11-12-08';

    // ===== 1) 토큰 체크 (비로그인 시 로그인 페이지로) =====
    (function () {
      const token = localStorage.getItem('jwt_token');
      if (!token) {
        alert('로그인이 필요한 서비스입니다. 로그인 페이지로 이동합니다.');
        window.location.href = 'student_login.html';
      }
    })();

    // ===== 2) 네비게이션 (버전 쿼리 붙여 최신 강제) =====
    const vq = (path) => `${path}?v=${encodeURIComponent(APP_VERSION)}`;
    const routes = {
      home:   vq('welcome.html'),
      search: vq('search.html'),
      saved:  vq('saved_list.html'),
      prac:   vq('practical.html'),
      ranking: vq('ranking.html'),
      my:     vq('mypage.html')
    };
    // 초기 프레임 로드
    (function () {
      document.getElementById('contentFrame').src = routes.home;
      document.getElementById('nav-home').href   = routes.home;
      document.getElementById('nav-search').href = routes.search;
      document.getElementById('nav-saved').href  = routes.saved;
      document.getElementById('nav-prac').href   = routes.prac;
      document.getElementById('nav-ranking').href = routes.ranking;
      document.getElementById('nav-my').href     = routes.my;
    })();

    // ===== 3) 로딩 인디케이터 & 탭 활성화 =====
    function setActive(element) {
      document.getElementById('loadingIndicator').style.display = 'block';
      document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
      element.classList.add('active');
      document.getElementById('contentFrame').addEventListener('load', function onload() {
        document.getElementById('loadingIndicator').style.display = 'none';
        this.removeEventListener('load', onload);
      });
    }
    window.addEventListener('load', () => {
      document.getElementById('loadingIndicator').style.display = 'none';
    });

    // ===== 4) SW: 버전 바뀌었을 때 "한 번만" 기존 SW unregister =====
    (async function oneTimeUnregisterOnVersionChange() {
      try {
        const KEY = 'imax_sw_version';
        if ('serviceWorker' in navigator) {
          const saved = localStorage.getItem(KEY);
          if (saved !== APP_VERSION) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
            localStorage.setItem(KEY, APP_VERSION);
            // 다음 줄은 "새 SW가 장악하면 자동 새로고침"을 위한 리스너와 함께 동작
          }
        }
      } catch (e) { /* noop */ }
    })();

    // ===== 5) SW 등록 (+즉시 업데이트 체크) =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => {
            // 최신 여부 확인
            reg.update?.();
          })
          .catch(err => console.log('서비스 워커 등록 실패:', err));
      });
    }

    // ===== 6) 새 SW가 컨트롤 잡으면 "한 번" 자동 새로고침 (즉시 최신 적용용) =====
    (function autoReloadOnceOnControllerChange() {
      let reloaded = false;
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (reloaded) return;
          reloaded = true;
          // 이미 열린 화면들까지 최신 정적 리소스로 교체
          location.reload();
        });
      }
    })();
  </script>
</body>
</html>


