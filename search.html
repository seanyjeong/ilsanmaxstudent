<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ëŒ€í•™ ì°¾ê¸°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee; --gray: #adb5bd; --gray-light: #e9ecef;
            --dark: #1e1e2e; --light: #f8f9fa; --border-radius: 12px;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.05);
            --transition: all 0.3s ease;
            --success: #28a745; --danger: #dc3545; --warning: #ffc107;
            --orange: #fd7e14;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6; margin: 0; padding: 0; color: var(--dark);
        }
        .header {
            background-color: #fff; padding: 15px 20px; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--gray-light);
            position: sticky; top: 0; z-index: 10;
        }
        .header h2 { margin: 0; font-size: 20px; font-weight: 700; }
        .header-icons button { background: none; border: none; font-size: 18px; color: var(--dark); cursor: pointer; margin-left: 15px; }

        /* ğŸ” ê²€ìƒ‰ ë°” */
        .search-bar {
            display: none;
            padding: 8px 16px;
            background-color: #fff;
            border-bottom: 1px solid var(--gray-light);
            align-items: center;
            gap: 8px;
        }
        .search-bar.open {
            display: flex;
        }
        .search-input {
            flex: 1;
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid var(--gray-light);
            font-size: 14px;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .search-clear-btn {
            border: none;
            background: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--gray);
        }
        .search-clear-btn:hover {
            color: var(--dark);
        }

        .filter-panel {
            background-color: var(--light); padding: 20px;
            border-bottom: 1px solid var(--gray-light); display: none;
            max-height: 0; overflow-y: auto;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .filter-panel.open { display: block; max-height: 80vh; padding: 20px; }
        .filter-group { margin-bottom: 15px; }
        .filter-group label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; }
        .filter-options { display: flex; flex-wrap: wrap; gap: 8px; }
        .filter-options button { padding: 8px 12px; font-size: 13px; border: 1px solid var(--gray-light); border-radius: 20px; background-color: #fff; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .filter-options button:hover { background-color: var(--gray-light); }
        .filter-options button.active { background-color: var(--primary); color: white; border-color: var(--primary); font-weight: 600; }
        .filter-actions { display: flex; gap: 10px; margin-top: 20px; }
        .filter-actions button { flex: 1; padding: 10px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: background-color 0.2s; }
        .reset-btn { background-color: var(--gray-light); color: var(--dark); }
        .reset-btn:hover { background-color: #dee2e6; }
        .apply-btn { background-color: var(--primary); color: #fff; }
        .apply-btn:hover { background-color: #3a54d8; }

        .gun-filter-buttons { display: flex; justify-content: center; padding: 15px 20px 5px 20px; background-color: #f4f7f6; }
        .gun-filter-buttons button { padding: 8px 16px; margin: 0 5px; font-size: 14px; font-weight: 600; border: 1px solid var(--gray-light); border-radius: 20px; background-color: #fff; color: var(--dark); cursor: pointer; transition: var(--transition); }
        .gun-filter-buttons button:hover { background-color: var(--gray-light); }
        .gun-filter-buttons button.active { background-color: var(--primary); color: white; border-color: var(--primary); }

        .tag-legend-container {
            padding: 5px 20px 10px 20px;
            background-color: #f4f7f6;
            display: none;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            font-size: 12px;
            color: #555;
            border-bottom: 1px solid var(--gray-light);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        .legend-box.tag-required {
            background-color: #e7f3ff;
            border: 1px solid var(--primary);
        }
        .legend-box.tag-optional {
            background-color: #fff8f0;
            border: 1px solid var(--orange);
        }
        .legend-save-limit {
            color: var(--primary);
            font-weight: 600;
        }
        .legend-save-limit i {
            margin-right: 3px;
        }

        .university-list { padding: 10px 20px 20px 20px; }
        .university-card { background-color: #fff; border-radius: var(--border-radius); margin-bottom: 15px; padding: 15px; box-shadow: var(--card-shadow); font-size: 14px; transition: var(--transition); position: relative; overflow: hidden; display: block; }
        .university-card.hidden-by-filter { display: none; }
        .uni-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .uni-name { font-weight: 700; font-size: 17px; margin-bottom: 3px; flex-grow: 1; padding-right: 50px; }
        .dept-name { color: #555; margin-bottom: 10px; font-size: 14px; }
        .uni-info { margin-bottom: 10px; }

        .uni-info span { display: inline-block; background-color: var(--gray-light); color: #555; font-size: 11px; padding: 3px 8px; border-radius: 10px; margin-right: 5px; margin-bottom: 5px; line-height: 1.4; }

        .subject-tags-wrapper {
            display: flex; flex-direction: column; gap: 5px; margin-bottom: 5px;
        }
        .subject-tags {
            display: flex; flex-wrap: wrap; gap: 5px;
        }
        .tag-subject {
            display: inline-block;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
            line-height: 1.4;
        }
        .uni-info .tag-required {
            color: var(--primary);
            background-color: #e7f3ff;
            border: 1px solid var(--primary);
        }
        .uni-info .tag-optional {
            color: var(--orange);
            background-color: #fff8f0;
            border: 1px solid var(--orange);
        }
        .uni-info .tag-none {
            color: #555;
            background-color: #f0f0f0;
            border: 1px solid var(--gray);
        }
        .uni-info .tag-stage {
            display: inline-block;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-right: 5px; margin-bottom: 5px;
            line-height: 1.4;
            font-weight: 600;
            color: var(--danger);
            background-color: #fdeeee;
            border: 1px solid var(--danger);
        }

        .uni-score-section {
            margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .uni-cutoff-score {
            font-size: 13px; font-weight: 500; color: var(--warning); text-align: left;
        }
        .uni-cutoff-score .score-value { font-weight: 600; }
        .uni-calculated-score { font-size: 15px; font-weight: 700; color: var(--primary); text-align: right; }
        .uni-calculated-score .score-value { font-size: 17px; margin-left: 5px; }
        .uni-calculated-score .loading-spinner { font-size: 14px; color: var(--gray); margin-left: 5px; }

        .save-button { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 20px; cursor: pointer; color: var(--gray); transition: color 0.2s; padding: 5px; }
        .save-button:hover { color: var(--primary); }
        .save-button.saved { color: var(--success); }
        .save-button.limit-reached { color: var(--gray); cursor: not-allowed; opacity: 0.6; }

        .message-area { text-align: center; color: var(--gray); padding: 30px; }
    </style>
</head>
<body>
    <script>
        const JUNGSI_SVR = 'https://supermax.kr';
        const token = localStorage.getItem('jwt_token');
        let currentStudentProfile = null;
        let savedUniversities = {};
        let savedCountsByGun = { 'ê°€': 0, 'ë‚˜': 0, 'ë‹¤': 0 };
        const MAX_SAVE_PER_GUN = 3;
        const EXCLUDE_EVENTS_LIST = [ "ì¢Œì „êµ´", "ì²´ì „êµ´", "ì²´í›„êµ´", "ë©”ë””ì‹ ë³¼ë˜ì§€ê¸°", "ìœ—ëª¸ì¼ìœ¼í‚¤ê¸°", "ì œìë¦¬ë©€ë¦¬ë›°ê¸°" ];
        let allUniversitiesData = [];
        let cutoffsMap = {}; // ì§€ì ì»· ì €ì¥ìš©
        let currentSearchQuery = ''; // ğŸ” ê²€ìƒ‰ì–´ ìƒíƒœ

        // ê³¼ëª© íƒœê·¸ í¬ë§·íŒ… í—¬í¼
        function formatSubjectTag(raw) {
            if (!raw || raw.trim() === '') {
                return null; 
            }
            const s = raw.trim();
            if (s.startsWith('(') && s.endsWith(')')) {
                return { text: s.slice(1, -1), type: 'optional' };
            } else {
                return { text: s, type: 'required' };
            }
        }
    </script>

    <div class="header">
        <h2>ëŒ€í•™ ì°¾ê¸°</h2>
        <div class="header-icons">
            <button id="searchBtn" title="ëŒ€í•™ëª…/í•™ê³¼ëª… ê²€ìƒ‰"><i class="fa-solid fa-magnifying-glass"></i></button>
            <button id="filterBtn" title="í•„í„° ì—´ê¸°/ë‹«ê¸°"><i class="fa-solid fa-filter"></i></button>
        </div>
    </div>

    <!-- ğŸ” ê²€ìƒ‰ ë°” (í•„í„° ì ìš© í›„ ì¹´ë“œì—ì„œë§Œ ê²€ìƒ‰) -->
    <div class="search-bar" id="searchBar">
        <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="ëŒ€í•™ëª… ë˜ëŠ” í•™ê³¼ëª…ìœ¼ë¡œ ê²€ìƒ‰"
        >
        <button id="searchClearBtn" class="search-clear-btn" title="ê²€ìƒ‰ ì´ˆê¸°í™”">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <div class="filter-panel" id="filterPanel">
        <div class="filter-group">
            <label><i class="fa-solid fa-location-dot"></i> ì§€ì—­ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</label>
            <div class="filter-options" id="regionFilters">
                <span style="font-size: 12px; color: var(--gray);">ì§€ì—­ ëª©ë¡ ë¡œë”© ì¤‘...</span>
            </div>
        </div>
        <div class="filter-group">
            <label><i class="fa-solid fa-graduation-cap"></i> êµì§ ì´ìˆ˜</label>
            <div class="filter-options">
                <button class="filter-teaching active" data-teaching="ì „ì²´">ì „ì²´</button>
                <button class="filter-teaching" data-teaching="O">ê°€ëŠ¥ (ì¼ë¶€ê°€ëŠ¥ í¬í•¨)</button>
                <button class="filter-teaching" data-teaching="X">ë¶ˆê°€ëŠ¥</button>
            </div>
        </div>
        
        <div class="filter-group">
            <label><i class="fa-solid fa-book"></i> ì œì™¸í•  ë°˜ì˜ ê³¼ëª© (ì„ íƒ ì‹œ í•´ë‹¹ ê³¼ëª© *í•„ìˆ˜* ëŒ€í•™ë§Œ ì œì™¸)</label>
            <div class="filter-options" id="excludeSubjectsFilters">
                <button class="filter-exclude-subject" data-subject="êµ­ì–´">êµ­ì–´</button>
                <button class="filter-exclude-subject" data-subject="ìˆ˜í•™">ìˆ˜í•™</button>
                <button class="filter-exclude-subject" data-subject="ì˜ì–´">ì˜ì–´</button>
                <button class="filter-exclude-subject" data-subject="íƒêµ¬">íƒêµ¬</button>
            </div>
        </div>
        <div class="filter-group">
            <label><i class="fa-solid fa-flask"></i> íƒêµ¬ ë°˜ì˜ ê°œìˆ˜ (1ê°œ ë˜ëŠ” 2ê°œ)</label>
            <div class="filter-options">
                <button class="filter-inquiry-count active" data-count="ì „ì²´">ì „ì²´</button>
                <button class="filter-inquiry-count" data-count="1">1ê°œ</button>
                <button class="filter-inquiry-count" data-count="2">2ê°œ</button>
            </div>
        </div>
        
        <div class="filter-group">
            <label><i class="fa-solid fa-person-running"></i> ì œì™¸í•  ì‹¤ê¸° ì¢…ëª© (ì„ íƒ ì‹œ í•´ë‹¹ ì¢…ëª© ì—†ëŠ” ëŒ€í•™ë§Œ í‘œì‹œ)</label>
            <div class="filter-options" id="excludeEventsFilters"></div>
        </div>
        <div class="filter-actions">
            <button class="reset-btn" onclick="resetFilters()">ì´ˆê¸°í™”</button>
            <button class="apply-btn" onclick="applyFilters()">ì ìš©í•˜ê¸°</button>
        </div>
    </div>

    <div class="gun-filter-buttons" id="gunFilterButtons" style="display: none;">
        <button class="gun-filter active" data-gun-filter="ì „ì²´">ì „ì²´</button>
        <button class="gun-filter" data-gun-filter="ê°€">ê°€êµ°</button>
        <button class="gun-filter" data-gun-filter="ë‚˜">ë‚˜êµ°</button>
        <button class="gun-filter" data-gun-filter="ë‹¤">ë‹¤êµ°</button>
    </div>

    <div class="tag-legend-container" id="tagLegendContainer">
        <span class="legend-item">
            <span class="legend-box tag-required"></span> : í•„ìˆ˜ë°˜ì˜
        </span>
        <span class="legend-item">
            <span class="legend-box tag-optional"></span> : ì„ íƒë°˜ì˜
        </span>
        <span class="legend-item legend-save-limit">
            <i class="fa-solid fa-circle-info"></i> ê° êµ°ë‹¹ 3ê°œ ì €ì¥ ê°€ëŠ¥
        </span>
    </div>

    <div class="university-list" id="universityList">
        <p class="message-area" id="messageArea">í•„í„°ë¥¼ ì„¤ì •í•˜ê³  'ì ìš©í•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
    </div>

    <script>
        const filterPanel = document.getElementById('filterPanel');
        const filterBtn = document.getElementById('filterBtn');
        const universityList = document.getElementById('universityList');
        const messageArea = document.getElementById('messageArea');
        const gunFilterButtonsContainer = document.getElementById('gunFilterButtons');
        const tagLegendContainer = document.getElementById('tagLegendContainer');

        const searchBtn = document.getElementById('searchBtn');
        const searchBar = document.getElementById('searchBar');
        const searchInput = document.getElementById('searchInput');
        const searchClearBtn = document.getElementById('searchClearBtn');

        document.addEventListener('DOMContentLoaded', async () => {
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.parent.location.href = 'student_login.html';
                return;
            }
            await loadStudentProfile();
            if (currentStudentProfile) {
                await Promise.all([
                    loadSavedUniversities(),
                    loadCutoffData(),
                    loadRegionFilters()
                ]);
                populateEventFilters();
                setupActionButtons();
            }

            // ğŸ” ê²€ìƒ‰ ë²„íŠ¼ í† ê¸€
            searchBtn.addEventListener('click', () => {
                const isOpen = searchBar.classList.toggle('open');
                if (isOpen) {
                    searchInput.focus();
                } else {
                    // ê²€ìƒ‰ì°½ ë‹«ì„ ë•Œë„ í˜„ì¬ ê²€ìƒ‰ì–´ ê¸°ì¤€ìœ¼ë¡œ í•„í„° ìœ ì§€
                    filterCardsByAllCriteria();
                }
            });

            // ğŸ” ì…ë ¥í•  ë•Œë§ˆë‹¤ í•„í„°ë§ (ì´ë¯¸ ë Œë”ëœ ì¹´ë“œë“¤ ìœ„ì—ì„œë§Œ)
            searchInput.addEventListener('input', () => {
                currentSearchQuery = searchInput.value;
                filterCardsByAllCriteria();
            });

            // âŒ ê²€ìƒ‰ ì´ˆê¸°í™” ë²„íŠ¼
            searchClearBtn.addEventListener('click', () => {
                searchInput.value = '';
                currentSearchQuery = '';
                filterCardsByAllCriteria();
                searchInput.focus();
            });
        });

        async function loadStudentProfile() {
            messageArea.textContent = 'í•™ìƒ ì •ë³´ ë¡œë“œ ì¤‘...';
            try {
                const res = await fetch(`${JUNGSI_SVR}/jungsi/student/my-profile`, { headers: { 'Authorization': 'Bearer ' + token }});
                const data = await res.json();
                if (!res.ok) throw new Error(`[${res.status}] ${data.message || 'í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨'}`);
                if (!data.success) throw new Error(data.message || 'í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨ (Success: false)');
                currentStudentProfile = data.profile;
                console.log('Student Profile Loaded:', currentStudentProfile);
                if (!currentStudentProfile.scores) throw new Error('ìˆ˜ëŠ¥ ì„±ì  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë§ˆì´í˜ì´ì§€ì—ì„œ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                messageArea.textContent = 'í•„í„°ë¥¼ ì„¤ì •í•˜ê³  \'ì ìš©í•˜ê¸°\' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
                messageArea.style.color = 'var(--gray)';
            } catch (err) {
                console.error('í•™ìƒ í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', err);
                messageArea.textContent = `ì˜¤ë¥˜: ${err.message}`;
                messageArea.style.color = 'red';
                currentStudentProfile = null;
            }
        }

        async function loadSavedUniversities() {
            savedUniversities = {};
            savedCountsByGun = { 'ê°€': 0, 'ë‚˜': 0, 'ë‹¤': 0 };
            try {
                const res = await fetch(`${JUNGSI_SVR}/jungsi/student/saved-universities`, { headers: { 'Authorization': 'Bearer ' + token }});
                const data = await res.json();
                if (!res.ok) throw new Error(`[${res.status}] ì €ì¥ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨`);
                if (!data.success) throw new Error('ì €ì¥ëœ ëŒ€í•™ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ (Success: false)');
                data.list.forEach(item => {
                    savedUniversities[item.U_ID] = item.saved_id;
                    if (item.êµ° && savedCountsByGun[item.êµ°] !== undefined) savedCountsByGun[item.êµ°]++;
                });
                console.log('Saved Universities Loaded:', savedUniversities, savedCountsByGun);
            } catch (err) {
                console.error('ì €ì¥ëœ ëŒ€í•™ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
            }
        }

        async function loadCutoffData() {
            cutoffsMap = {};
            if (!currentStudentProfile || !currentStudentProfile.í•™ë…„ë„) return;
            const year = currentStudentProfile.í•™ë…„ë„;
            const apiUrl = `${JUNGSI_SVR}/jungsi/cutoffs/${year}`;
            console.log('API ìš”ì²­ (ì»·ì ìˆ˜):', apiUrl);
            try {
                const res = await fetch(apiUrl, { headers: { 'Authorization': 'Bearer ' + token }});
                const data = await res.json();
                if (!res.ok) throw new Error(`[${res.status}] ì»·ì ìˆ˜ ë¡œë“œ ì‹¤íŒ¨`);
                if (!data.success) throw new Error('ì»·ì ìˆ˜ ë¡œë“œ ì‹¤íŒ¨ (Success: false)');
                if (data.cutoffs && Array.isArray(data.cutoffs)) {
                    data.cutoffs.forEach(item => {
                        cutoffsMap[item.U_ID] = item.ì§€ì _ìˆ˜ëŠ¥ì»·;
                    });
                    console.log('Branch Cutoff Data Loaded:', cutoffsMap);
                } else {
                    console.warn('No cutoffs data received.');
                }
            } catch (err) {
                console.error('ì»·ì ìˆ˜ ë¡œë“œ ì‹¤íŒ¨:', err);
            }
        }

        async function loadRegionFilters() {
            const container = document.getElementById('regionFilters');
            if (!currentStudentProfile || !currentStudentProfile.í•™ë…„ë„) {
                container.innerHTML = '<span style="font-size: 12px; color: var(--danger);">í•™ìƒ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨</span>';
                return;
            }
            const year = currentStudentProfile.í•™ë…„ë„;
            const apiUrl = `${JUNGSI_SVR}/jungsi/public/regions/${year}`;
            console.log('API ìš”ì²­ (ì§€ì—­ ëª©ë¡):', apiUrl);

            try {
                const res = await fetch(apiUrl, { headers: { 'Authorization': 'Bearer ' + token }});
                const data = await res.json();
                if (!res.ok) throw new Error(`[${res.status}] ì§€ì—­ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨`);
                if (!data.success || !Array.isArray(data.regions)) throw new Error('ì§€ì—­ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ (Success: false)');

                container.innerHTML = '';
                
                const allBtn = document.createElement('button');
                allBtn.className = 'filter-region active';
                allBtn.dataset.region = 'ì „ì²´';
                allBtn.textContent = 'ì „ì²´';
                container.appendChild(allBtn);

                data.regions.forEach(region => {
                    const button = document.createElement('button');
                    button.className = 'filter-region';
                    button.dataset.region = region;
                    button.textContent = region;
                    container.appendChild(button);
                });

                container.querySelectorAll('.filter-region').forEach(button => {
                    button.addEventListener('click', () => handleMultiSelectWithAll(button, '.filter-region', 'ì „ì²´'));
                });

            } catch (err) {
                console.error('ì§€ì—­ í•„í„° ë¡œë“œ ì‹¤íŒ¨:', err);
                container.innerHTML = `<span style="font-size: 12px; color: var(--danger);">ì˜¤ë¥˜: ${err.message}</span>`;
            }
        }

        filterBtn.addEventListener('click', () => {
            filterPanel.classList.toggle('open');
            filterBtn.innerHTML = filterPanel.classList.contains('open') ? '<i class="fa-solid fa-xmark"></i>' : '<i class="fa-solid fa-filter"></i>';
        });

        function populateEventFilters() {
            const container = document.getElementById('excludeEventsFilters');
            container.innerHTML = '';
            EXCLUDE_EVENTS_LIST.forEach(event => {
                const button = document.createElement('button');
                button.classList.add('filter-exclude-event');
                button.dataset.event = event;
                button.textContent = event;
                container.appendChild(button);
            });
        }

        function setupActionButtons() {
            document.querySelectorAll('.filter-teaching').forEach(button =>
                button.addEventListener('click', () => handleSingleSelect(button, '.filter-teaching'))
            );
            document.querySelectorAll('.filter-exclude-event').forEach(button =>
                button.addEventListener('click', () => button.classList.toggle('active'))
            );
            document.querySelectorAll('.filter-exclude-subject').forEach(button =>
                button.addEventListener('click', () => button.classList.toggle('active'))
            );
            document.querySelectorAll('.filter-inquiry-count').forEach(button =>
                button.addEventListener('click', () => handleSingleSelect(button, '.filter-inquiry-count'))
            );

            document.querySelectorAll('.gun-filter').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.gun-filter.active').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    filterCardsByAllCriteria();
                });
            });

            document.querySelectorAll('.filter-teaching').forEach(button => {
                button.addEventListener('click', () => {
                    setTimeout(filterCardsByAllCriteria, 0);
                });
            });
        }

        function handleSingleSelect(clickedButton, selector) {
            document.querySelectorAll(`${selector}.active`).forEach(b => b.classList.remove('active'));
            clickedButton.classList.add('active');
        }

        function handleMultiSelectWithAll(clickedButton, selector, allValue) {
            const dataAttrName = Object.keys(clickedButton.dataset)[0];
            const allButton = document.querySelector(`${selector}[data-${dataAttrName}="${allValue}"]`);
            if (clickedButton === allButton) {
                document.querySelectorAll(`${selector}.active`).forEach(b => b.classList.remove('active'));
                if (allButton) allButton.classList.add('active');
            } else {
                if (allButton) allButton.classList.remove('active');
                clickedButton.classList.toggle('active');
                if (!document.querySelector(`${selector}.active`)) {
                    if (allButton) allButton.classList.add('active');
                }
            }
        }

        function filterCardsByAllCriteria() {
            const selectedGun = document.querySelector('.gun-filter.active')?.dataset.gunFilter || 'ì „ì²´';
            const selectedTeaching = document.querySelector('.filter-teaching.active')?.dataset.teaching || 'ì „ì²´';
            const q = (currentSearchQuery || '').trim().toLowerCase();   // ğŸ” ê²€ìƒ‰ì–´

            console.log("Filtering by Gun:", selectedGun, "Teaching:", selectedTeaching, "Query:", q);

            const cards = universityList.querySelectorAll('.university-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const cardGun = card.dataset.gun || '';
                const cardTeaching = card.dataset.teaching || '';

                const gunMatch = (selectedGun === 'ì „ì²´' || cardGun === selectedGun);
                let teachingMatch = false;
                if (selectedTeaching === 'ì „ì²´') {
                    teachingMatch = true;
                } else if (selectedTeaching === 'O') {
                    teachingMatch = (cardTeaching === 'O' || cardTeaching === 'â–³');
                } else {
                    teachingMatch = (cardTeaching === selectedTeaching);
                }

                const uniName = (card.querySelector('.uni-name')?.textContent || '').toLowerCase();
                const deptName = (card.querySelector('.dept-name')?.textContent || '').toLowerCase();
                const textMatch = !q || uniName.includes(q) || deptName.includes(q);

                if (gunMatch && teachingMatch && textMatch) {
                    card.classList.remove('hidden-by-filter');
                    visibleCount++;
                } else {
                    card.classList.add('hidden-by-filter');
                }
            });

            if (visibleCount === 0 && cards.length > 0) {
                messageArea.textContent = 'ì„ íƒí•œ ì¡°ê±´ ë° ê²€ìƒ‰ì–´ì— ë§ëŠ” ëŒ€í•™ì´ ì—†ìŠµë‹ˆë‹¤.';
                messageArea.style.display = 'block';
            } else if (cards.length > 0) {
                messageArea.style.display = 'none';
            }
        }

        async function applyFilters() {
            if (!currentStudentProfile || !currentStudentProfile.scores) {
                messageArea.textContent = currentStudentProfile ? 'ìˆ˜ëŠ¥ ì„±ì  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë§ˆì´í˜ì´ì§€ì—ì„œ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.' : 'í•™ìƒ ì •ë³´ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ì•¼ í•©ë‹ˆë‹¤.';
                messageArea.style.display = 'block';
                gunFilterButtonsContainer.style.display = 'none';
                tagLegendContainer.style.display = 'none';
                return;
            }
            messageArea.textContent = 'ëŒ€í•™ ëª©ë¡ ê²€ìƒ‰ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
            messageArea.style.display = 'block';
            universityList.innerHTML = '';
            filterPanel.classList.remove('open');
            filterBtn.innerHTML = '<i class="fa-solid fa-filter"></i>';
            gunFilterButtonsContainer.style.display = 'none';
            tagLegendContainer.style.display = 'none';
            allUniversitiesData = [];

            const selectedRegions = Array.from(document.querySelectorAll('.filter-region.active')).map(b => b.dataset.region).filter(r => r !== 'ì „ì²´');
            const selectedExcludeEvents = Array.from(document.querySelectorAll('.filter-exclude-event.active')).map(b => b.dataset.event);
            const selectedExcludeSubjects = Array.from(document.querySelectorAll('.filter-exclude-subject.active')).map(b => b.dataset.subject);
            const selectedInquiryCount = document.querySelector('.filter-inquiry-count.active')?.dataset.count || 'ì „ì²´';
            
            const params = new URLSearchParams();
            if (selectedRegions.length > 0) params.append('region', selectedRegions.join(','));
            if (selectedExcludeEvents.length > 0) params.append('exclude_events', selectedExcludeEvents.join(','));
            if (selectedExcludeSubjects.length > 0) params.append('exclude_subjects', selectedExcludeSubjects.join(','));
            if (selectedInquiryCount !== 'ì „ì²´') params.append('inquiry_count', selectedInquiryCount);

            const apiUrl = `${JUNGSI_SVR}/jungsi/public/schools/${currentStudentProfile.í•™ë…„ë„}?${params.toString()}`;
            console.log('API ìš”ì²­ (ëŒ€í•™ ëª©ë¡):', apiUrl);

            try {
                const listRes = await fetch(apiUrl, { headers: { 'Authorization': 'Bearer ' + token }});
                const listData = await listRes.json();
                if (!listRes.ok) throw new Error(`[${listRes.status}] ${listData.message || 'ëŒ€í•™ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨'}`);
                if (!listData.success) throw new Error(listData.message || 'ëŒ€í•™ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ (Success: false)');
                allUniversitiesData = listData.universities || [];

                if (allUniversitiesData.length === 0) {
                    messageArea.textContent = 'ì¡°ê±´ì— ë§ëŠ” ëŒ€í•™ì´ ì—†ìŠµë‹ˆë‹¤.';
                    messageArea.style.display = 'block';
                    return;
                }

                messageArea.textContent = `ì´ ${allUniversitiesData.length}ê°œ ëŒ€í•™ ì •ë³´ ë¡œë”© ë° ì ìˆ˜ ê³„ì‚° ì¤‘...`;
                universityList.innerHTML = '';

                const batchSize = 10;
                let createdCardsCount = 0;
                for (let i = 0; i < allUniversitiesData.length; i += batchSize) {
                    const batch = allUniversitiesData.slice(i, i + batchSize);
                    const cardPromises = batch.map(uni => processUniversity(uni));
                    const cards = await Promise.all(cardPromises);
                    cards.filter(card => card !== null).forEach(card => {
                        universityList.appendChild(card);
                        createdCardsCount++;
                    });
                    messageArea.textContent = `ì´ ${allUniversitiesData.length}ê°œ ì¤‘ ${Math.min(i + batchSize, allUniversitiesData.length)}ê°œ ì²˜ë¦¬ ì™„ë£Œ...`;
                }

                if (createdCardsCount === 0 && allUniversitiesData.length > 0) {
                    messageArea.textContent = 'ê²°ê³¼ë¥¼ í‘œì‹œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    messageArea.style.display = 'block';
                } else if (createdCardsCount > 0) {
                    messageArea.style.display = 'none';
                    gunFilterButtonsContainer.style.display = 'flex';
                    tagLegendContainer.style.display = 'flex';
                    document.querySelectorAll('.gun-filter.active').forEach(b => b.classList.remove('active'));
                    document.querySelector('.gun-filter[data-gun-filter="ì „ì²´"]').classList.add('active');
                    filterCardsByAllCriteria();
                } else {
                    messageArea.textContent = 'ì¡°ê±´ì— ë§ëŠ” ëŒ€í•™ì´ ì—†ìŠµë‹ˆë‹¤.';
                    messageArea.style.display = 'block';
                }

            } catch (err) {
                if (err instanceof SyntaxError) {
                    console.error("JSON íŒŒì‹± ì˜¤ë¥˜:", err);
                    messageArea.textContent = 'ì„œë²„ ì‘ë‹µ í˜•ì‹ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤. (JSON ì˜¤ë¥˜)';
                } else {
                    console.error(err);
                    messageArea.textContent = `ì˜¤ë¥˜: ${err.message}`;
                }
                messageArea.style.color = 'red';
                messageArea.style.display = 'block';
            } finally {
                if (universityList.children.length === 0) {
                    gunFilterButtonsContainer.style.display = 'none';
                    tagLegendContainer.style.display = 'none';
                }
            }
        }

        async function processUniversity(uni) {
            try {
                const detailRes = await fetch(`${JUNGSI_SVR}/jungsi/school-details`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ U_ID: uni.U_ID, year: currentStudentProfile.í•™ë…„ë„ })
                });
                if (!detailRes.ok) throw new Error(`ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ (${detailRes.status})`);
                const detailData = await detailRes.json();
                if (!detailData.success) throw new Error(`ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ (U_ID: ${uni.U_ID})`);
                const F_data = detailData.data;

                const calculateRes = await fetch(`${JUNGSI_SVR}/jungsi/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({
                        U_ID: uni.U_ID,
                        year: currentStudentProfile.í•™ë…„ë„,
                        studentScores: { subjects: convertProfileToSubjects(currentStudentProfile.scores) }
                    })
                });
                if (!calculateRes.ok) throw new Error(`ì ìˆ˜ ê³„ì‚° ì‹¤íŒ¨ (${calculateRes.status})`);
                const calculateData = await calculateRes.json();
                let calculatedScore = null;
                if (calculateData.success && calculateData.result.totalScore) {
                    calculatedScore = parseFloat(calculateData.result.totalScore).toFixed(2);
                } else {
                    console.warn(`ì ìˆ˜ ê³„ì‚° ì‹¤íŒ¨ (U_ID: ${uni.U_ID}): ${calculateData.message}`);
                }

                const card = createUniversityCard(uni, F_data, calculatedScore);
                card.dataset.teaching = uni.teacher || '';
                card.dataset.gun = uni.gun || '';
                return card;
            } catch (cardErr) {
                console.error(`ì¹´ë“œ ìƒì„± ì˜¤ë¥˜ (U_ID: ${uni.U_ID}):`, cardErr);
                return null;
            }
        }

        function convertProfileToSubjects(scores) {
            if (!scores) return [];
            const subjects = [];
            const addSubject = (name, subjectKey, stdKey, pctKey, gradeKey) => {
                if (scores[subjectKey] || scores[gradeKey]) {
                    subjects.push({
                        name: name,
                        subject: scores[subjectKey] || null,
                        std: scores[stdKey] || null,
                        percentile: scores[pctKey] || null,
                        grade: scores[gradeKey] || null
                    });
                }
            };
            addSubject('êµ­ì–´', 'êµ­ì–´_ì„ íƒê³¼ëª©', 'êµ­ì–´_í‘œì¤€ì ìˆ˜', 'êµ­ì–´_ë°±ë¶„ìœ„', 'êµ­ì–´_ë“±ê¸‰');
            addSubject('ìˆ˜í•™', 'ìˆ˜í•™_ì„ íƒê³¼ëª©', 'ìˆ˜í•™_í‘œì¤€ì ìˆ˜', 'ìˆ˜í•™_ë°±ë¶„ìœ„', 'ìˆ˜í•™_ë“±ê¸‰');
            addSubject('ì˜ì–´', null, null, null, 'ì˜ì–´_ë“±ê¸‰');
            addSubject('í•œêµ­ì‚¬', null, null, null, 'í•œêµ­ì‚¬_ë“±ê¸‰');
            addSubject('íƒêµ¬', 'íƒêµ¬1_ì„ íƒê³¼ëª©', 'íƒêµ¬1_í‘œì¤€ì ìˆ˜', 'íƒêµ¬1_ë°±ë¶„ìœ„', 'íƒêµ¬1_ë“±ê¸‰');
            addSubject('íƒêµ¬', 'íƒêµ¬2_ì„ íƒê³¼ëª©', 'íƒêµ¬2_í‘œì¤€ì ìˆ˜', 'íƒêµ¬2_ë°±ë¶„ìœ„', 'íƒêµ¬2_ë“±ê¸‰');
            return subjects;
        }

        function resetFilters() {
            handleMultiSelectWithAll(document.querySelector('.filter-region[data-region="ì „ì²´"]'), '.filter-region', 'ì „ì²´');
            handleSingleSelect(document.querySelector('.filter-teaching[data-teaching="ì „ì²´"]'), '.filter-teaching');
            
            document.querySelectorAll('.filter-exclude-subject.active').forEach(b => b.classList.remove('active'));
            handleSingleSelect(document.querySelector('.filter-inquiry-count[data-count="ì „ì²´"]'), '.filter-inquiry-count');
            
            document.querySelectorAll('.filter-exclude-event.active').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.gun-filter.active').forEach(b => b.classList.remove('active'));
            document.querySelector('.gun-filter[data-gun-filter="ì „ì²´"]').classList.add('active');

            currentSearchQuery = '';
            if (searchInput) searchInput.value = '';

            applyFilters();
        }

        // ============================ ëŒ€í•™ ì¹´ë“œ ìƒì„± ============================
        function createUniversityCard(uni, fData, calculatedScore) {
            const div = document.createElement('div');
            div.className = 'university-card';
            
            // 1. ê³¼ëª©ë³„ ë°˜ì˜ íƒœê·¸
            const subjects = [];
            const korTag = formatSubjectTag(uni.êµ­ì–´_raw);
            if (korTag) subjects.push({ name: 'êµ­', ...korTag });

            const mathTag = formatSubjectTag(uni.ìˆ˜í•™_raw);
            if (mathTag) subjects.push({ name: 'ìˆ˜', ...mathTag });

            const engTag = formatSubjectTag(uni.ì˜ì–´_raw);
            if (engTag) subjects.push({ name: 'ì˜', ...engTag });

            const tamTag = formatSubjectTag(uni.íƒêµ¬_raw);
            if (tamTag) {
                const count = uni.íƒêµ¬ìˆ˜_raw || '';
                subjects.push({ name: `íƒ${count}`, ...tamTag });
            }
            
            const hanTag = formatSubjectTag(uni.í•œêµ­ì‚¬_raw);
            if (hanTag) subjects.push({ name: 'í•œ', ...hanTag });

            let subjectsHtml = '';
            if (subjects.length > 0) {
                subjectsHtml = '<div class="subject-tags">' + subjects.map(tag => {
                    let displayText = tag.text;
                    if (!isNaN(parseFloat(displayText)) && isFinite(displayText)) {
                        displayText = `${displayText}%`;
                    }
                    return `<span class="tag-subject tag-${tag.type}">${tag.name} ${displayText}</span>`;
                }).join(' ') + '</div>';
            } else {
                subjectsHtml = '<div class="subject-tags"><span class="tag-subject tag-none">ìˆ˜ëŠ¥ë°˜ì˜X</span></div>';
            }

            // 2. ì „ì²´ ë¹„ìœ¨ íƒœê·¸
            const suneungR = uni.suneungRatio || 0;
            const naeshinR = uni.naeshinRatio || 0;
            const practicalR = uni.practicalRatio || 0;
            let ratioHtml = '';
            if (suneungR > 0 || naeshinR > 0 || practicalR > 0) {
                ratioHtml = `
                    <div class="subject-tags">
                        <span class="tag-subject tag-none">
                            ìˆ˜ëŠ¥ ${suneungR}% + ë‚´ì‹  ${naeshinR}% + ì‹¤ê¸° ${practicalR}%
                        </span>
                    </div>`;
            }

            // 3. ë‹¨ê³„ë³„ ì „í˜• íƒœê·¸
            let stageTag = '';
            if (uni.stageMultiple && Number(uni.stageMultiple) > 0) {
                stageTag = `<span class="tag-stage">1ë‹¨ê³„ ${uni.stageMultiple}ë°°ìˆ˜</span>`;
            }

            // 4. ê¸°íƒ€ ì •ë³´ íƒœê·¸
            const infoTags = [
                uni.gun ? `<span>${uni.gun}</span>` : '',
                uni.regionWide ? `<span>${uni.regionWide}</span>` : '',
                uni.teacher === 'O'
                    ? '<span style="color: green; border: 1px solid green; background: #e6f7e6;">êµì§O</span>'
                    : (uni.teacher === 'â–³'
                        ? '<span style="color: orange; border: 1px solid orange; background: #fff3e0;">êµì§â–³</span>'
                        : (uni.teacher === 'X'
                            ? '<span style="color: red; border: 1px solid red; background: #ffe6e6;">êµì§X</span>'
                            : '')
                    ),
                uni.quota
                    ? `<span>ì •ì› ${uni.quota}ëª…</span>`
                    : (fData?.ëª¨ì§‘ì •ì› ? `<span>ì •ì› ${fData.ëª¨ì§‘ì •ì›}ëª…</span>` : ''),
            ].filter(Boolean).join('');

            // 5. ì‹¤ê¸° ì¢…ëª© íƒœê·¸
            const events = uni.events && uni.events.length > 0
                ? `<span>ì‹¤ê¸°: ${uni.events.join(', ')}</span>`
                : '<span style="color: gray; border: 1px solid gray; background: #f0f0f0;">ì‹¤ê¸°X</span>';

            // 6. ì €ì¥ ë²„íŠ¼
            const isSaved = savedUniversities[uni.U_ID] !== undefined;
            const gun = uni.gun || '';
            const isLimitReached = gun && savedCountsByGun[gun] >= MAX_SAVE_PER_GUN && !isSaved;
            let saveButtonClass = 'save-button';
            let saveButtonIcon = 'fa-regular fa-heart';
            let saveButtonTitle = 'ì €ì¥í•˜ê¸°';
            if (isSaved) {
                saveButtonClass += ' saved';
                saveButtonIcon = 'fa-solid fa-heart';
                saveButtonTitle = 'ì €ì¥ë¨ (í´ë¦­í•˜ì—¬ ì·¨ì†Œ)';
            } else if (isLimitReached) {
                saveButtonClass += ' limit-reached';
                saveButtonTitle = `${gun}êµ° ì €ì¥ (${MAX_SAVE_PER_GUN}ê°œ) ì œí•œ ë„ë‹¬`;
            }

            // 7. ì§€ì ì»·
            const branchCutoffScore = cutoffsMap[uni.U_ID];
            let cutoffHtml = '<span style="color: var(--gray);">ì§€ì ì»· ì—†ìŒ</span>';
            if (branchCutoffScore !== null && branchCutoffScore !== undefined) {
                cutoffHtml = `ì§€ì ì»·: <span class="score-value">${branchCutoffScore}ì </span>`;
            }

            // 8. HTML ì¡°ë¦½
            div.innerHTML = `
                <div class="uni-header">
                    <div class="uni-name">${uni.university}</div>
                    <button class="${saveButtonClass}" data-uid="${uni.U_ID}" data-gun="${gun}" data-score="${calculatedScore !== null ? calculatedScore : ''}" title="${saveButtonTitle}" ${isLimitReached ? 'disabled' : ''}>
                        <i class="${saveButtonIcon}"></i>
                    </button>
                </div>
                <div class="dept-name">${uni.department}</div>
                
                <div class="uni-info">
                    ${subjectsHtml}
                    ${ratioHtml}
                    ${stageTag}
                    ${infoTags}
                    ${events}
                </div>

                <div class="uni-score-section">
                    <div class="uni-cutoff-score">${cutoffHtml}</div>
                    <div class="uni-calculated-score">
                        ë‚´ ì ìˆ˜:
                        ${
                            calculatedScore !== null
                                ? `<span class="score-value">${calculatedScore}ì </span>`
                                : '<span class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> ê³„ì‚°ì¤‘..</span>'
                        }
                    </div>
                </div>
            `;

            const saveBtn = div.querySelector('.save-button');
            if (saveBtn && !isLimitReached) {
                saveBtn.onclick = (e) => {
                    e.stopPropagation();
                    handleSaveClick(saveBtn, uni.U_ID, gun);
                };
            } else if (saveBtn && isLimitReached) {
                saveBtn.onclick = (e) => e.stopPropagation();
            }

            return div;
        }

        async function handleSaveClick(button, uId, gun) {
            const isCurrentlySaved = button.classList.contains('saved');
            const savedId = savedUniversities[uId];
            const scoreToSave = button.dataset.score ? parseFloat(button.dataset.score) : null;

            if (!isCurrentlySaved && gun && savedCountsByGun[gun] >= MAX_SAVE_PER_GUN) {
                alert(`${gun}êµ°ì€ ìµœëŒ€ ${MAX_SAVE_PER_GUN}ê°œê¹Œì§€ë§Œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                return;
            }

            button.disabled = true;
            const icon = button.querySelector('i');
            icon.className = 'fas fa-spinner fa-spin';

            try {
                let apiUrl = '';
                let method = '';
                let body = {};

                if (isCurrentlySaved && savedId) {
                    apiUrl = `${JUNGSI_SVR}/jungsi/student/remove-university`;
                    method = 'POST';
                    body = { savedId: savedId };
                } else {
                    apiUrl = `${JUNGSI_SVR}/jungsi/student/save-university`;
                    method = 'POST';
                    body = { universityId: uId, í•™ë…„ë„: currentStudentProfile.í•™ë…„ë„, calculatedScore: scoreToSave };
                }
                
                const res = await fetch(apiUrl, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (!res.ok) throw new Error(`[${res.status}] ${data.message || (isCurrentlySaved ? 'ì·¨ì†Œ ì‹¤íŒ¨' : 'ì €ì¥ ì‹¤íŒ¨')}`);
                if (!data.success) throw new Error(data.message || (isCurrentlySaved ? 'ì·¨ì†Œ ì‹¤íŒ¨ (Success: false)' : 'ì €ì¥ ì‹¤íŒ¨ (Success: false)'));

                if (isCurrentlySaved) {
                    delete savedUniversities[uId];
                    if (gun && savedCountsByGun[gun] > 0) savedCountsByGun[gun]--;
                    console.log('ì €ì¥ ì·¨ì†Œ ì„±ê³µ:', uId, savedCountsByGun);
                } else {
                    savedUniversities[uId] = data.savedId || true;
                    if (gun) savedCountsByGun[gun]++;
                    console.log('ì €ì¥ ì„±ê³µ:', uId, savedCountsByGun);
                }

                updateSaveButtonStates(gun);

            } catch (err) {
                console.error('ì €ì¥/ì·¨ì†Œ ì˜¤ë¥˜:', err);
                if (err.message !== 'Limit reached') {
                    alert(`ì˜¤ë¥˜: ${err.message}`);
                }
                button.disabled = false;
                if (isCurrentlySaved) icon.className = 'fa-solid fa-heart';
                else icon.className = 'fa-regular fa-heart';
            }
        }

        function updateSaveButtonStates(targetGun) {
            if (!targetGun) return;
            
            const isLimitReachedForTargetGun = savedCountsByGun[targetGun] >= MAX_SAVE_PER_GUN;
            
            document.querySelectorAll(`.save-button[data-gun="${targetGun}"]`).forEach(btn => {
                const uId = btn.dataset.uid;
                const gun = btn.dataset.gun;
                const isSaved = savedUniversities[uId] !== undefined;

                btn.onclick = (e) => {
                    e.stopPropagation();
                    handleSaveClick(btn, uId, gun);
                };

                if (!isSaved) {
                    btn.classList.remove('saved');
                    
                    if (isLimitReachedForTargetGun) {
                        btn.classList.add('limit-reached');
                        btn.disabled = true;
                        btn.title = `${targetGun}êµ° ì €ì¥ (${MAX_SAVE_PER_GUN}ê°œ) ì œí•œ ë„ë‹¬`;
                        btn.querySelector('i').className = 'fa-regular fa-heart';
                        btn.onclick = (e) => e.stopPropagation();
                    } else {
                        btn.classList.remove('limit-reached');
                        btn.disabled = false;
                        btn.title = 'ì €ì¥í•˜ê¸°';
                        btn.querySelector('i').className = 'fa-regular fa-heart';
                    }
                } else {
                    btn.classList.add('saved');
                    btn.classList.remove('limit-reached');
                    btn.disabled = false;
                    btn.title = 'ì €ì¥ë¨ (í´ë¦­í•˜ì—¬ ì·¨ì†Œ)';
                    btn.querySelector('i').className = 'fa-solid fa-heart';
                }
            });
        }

        function logout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('jwt_token');
                window.parent.location.href = 'student_login.html';
            }
        }
    </script>
</body>
</html>
